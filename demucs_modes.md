# Режимы работы разделения вокала (Demucs / librosa)

Документ описывает актуальную реализацию разделения вокала в приложении.

## Как это работает сейчас

- Настройки Demucs задаются ТОЛЬКО в блоке конфигурации `main.py` (в начале файла). CLI-флаги `--demucs-quality` и `--demucs-model` не используются.
- При включённом улучшении аудио выполняется:
  1) Лёгкая предочистка исходника (HPF/эквализация) для лучшего разделения
  2) Запуск Demucs c параметрами из конфигурации (см. ниже)
  3) Мягкое вычитание фонового стема из вокального и пост-очистка вокала
  4) Сохранение `{stem}_vocals.wav` рядом с исходным файлом (перезапись, если уже существует)
- При ошибке Demucs выполняется упрощённое выделение голосового диапазона через librosa (fallback).
- В пакетном режиме файлы `*_vocals.*` пропускаются (чтобы избежать зацикливания).
- Параметр `--fast-mode` отключает улучшение аудио целиком (пропускает этап разделения для ускорения).

## Текущие значения по умолчанию (в конфигурации main.py)

- Модель: `htdemucs`
- Сдвиги (`--shifts`): `4`
- Перекрытие (`--overlap`): `0.4`
- Потоки (`-j`): `4`
- Два стема (`--two-stems`): `vocals` (извлекается только вокал)
- Устройство (`-d`): автоопределение — если доступна CUDA, используется `cuda`, иначе `cpu`

Приложение использует установленную в системе FFmpeg; расширения torio FFmpeg отключены переменными окружения (чтобы не шумели и не мешали работе), это не влияет на корректность разделения Demucs.

## Режимы и производительность

- По умолчанию выбран баланс качества и скорости: `htdemucs`, `shifts=4`, `overlap=0.4`, `jobs=4`.
- Увеличение `shifts` и `overlap` может улучшить качество (меньше «подмешивания» музыки в вокале), но замедляет обработку.
- Параметр `--fast-mode` полностью исключает стадию разделения для максимальной скорости.

## Примеры

Разделение управляется конфигурацией, а не CLI-флагами. Меняйте значения в блоке настроек в начале `main.py`:

```python
DEMUCS_MODEL = "htdemucs"
DEMUCS_SHIFTS = 4
DEMUCS_OVERLAP = 0.4
DEMUCS_DEVICE = "cuda"  # или "cpu"; при некорректном значении выбирается авто
DEMUCS_JOBS = 4
DEMUCS_TWO_STEMS = "vocals"
```

Запуск:
```bash
# Обычный запуск с улучшением аудио (если включено в конфигурации)
python main.py --file examples/song.mp3

# Быстрый запуск без разделения (ускорение)
python main.py --file examples/song.mp3 --fast-mode
```

## Рекомендации

- Для большинства треков `htdemucs` + `shifts=4` + `overlap=0.4` дают хороший компромисс между качеством и временем.
- Если слышно «просачивание» музыки в вокале, попробуйте повысить `shifts` и/или `overlap` в конфигурации.
- На машинах без CUDA Demucs автоматически пойдёт по CPU; при ошибке будет использован fallback через librosa.
- В случае повышенной болтливости внешних библиотек используйте уже включённое подавление вывода (torio FFmpeg extensions отключены).
