# Режимы работы разделения вокала (Demucs / librosa)

Краткое описание актуальной реализации разделения вокала.

## Как устроено сейчас
- Все параметры Demucs задаются ТОЛЬКО в блоке конфигурации `main.py` (в начале файла). Отдельных CLI-флагов качества/модели нет.
- Конвейер при включённом улучшении аудио:
  1) Лёгкая предочистка (HPF/эквализация)
  2) Разделение Demucs с параметрами из конфигурации
  3) Мягкое вычитание фонового стема из вокального + пост‑очистка
  4) Сохранение `{stem}_vocals.wav` рядом с исходником (перезаписывается)
- При ошибке Demucs выполняется fallback через librosa (упрощённое выделение голосового диапазона).
- В пакетном режиме `*_vocals.*` файлы пропускаются (исключены из первичного списка).
- `--fast-mode` отключает улучшение аудио целиком (быстрее, без разделения).

## Текущие дефолты (main.py)
- Модель: `htdemucs`
- Сдвиги (`shifts`): `4`
- Перекрытие (`overlap`): `0.4`
- Потоки (`jobs`): `4`
- Два стема (`two-stems`): `vocals`
- Устройство (`device`): авто (`cuda` при наличии, иначе `cpu`)

FFmpeg: используется системный FFmpeg. Расширения torio FFmpeg намеренно отключены (для тишины и стабильности) — на качество разделения это не влияет.

## Пресеты (рекомендуемые)
Ниже — практичные пресеты, настраиваются в конфигурации `main.py`.

1) Fast (максимальная скорость)
```python
ENABLE_AUDIO_ENHANCEMENT = False  # или запуск с --fast-mode
```
- Улучшение/разделение отключены. Прямой STT. Минимальные задержки.

2) Balanced (по умолчанию)
```python
DEMUCS_MODEL = "htdemucs"
DEMUCS_SHIFTS = 4
DEMUCS_OVERLAP = 0.4
DEMUCS_JOBS = 4
DEMUCS_TWO_STEMS = "vocals"
```
- Хороший компромисс «качество/время», подходит для большинства треков.

3) High‑quality (лучше подавление подмешивания музыки)
```python
DEMUCS_MODEL = "htdemucs"
DEMUCS_SHIFTS = 6  # 6–8
DEMUCS_OVERLAP = 0.5
DEMUCS_JOBS = 4
DEMUCS_TWO_STEMS = "vocals"
```
- Чище вокал, дольше обработка. Рекомендуется на сложных треках.

## Советы
- Если слышно «просачивание» музыки в вокале — увеличьте `shifts` и/или `overlap`.
- Без CUDA всё работает на CPU; при сбоях автоматически включится fallback через librosa.
- Для массовых прогонов без критичных требований к качеству используйте Fast.
