#!/usr/bin/env python3
"""
–ê—É–¥–∏–æ–∞–Ω–∞–ª–∏–∑–∞—Ç–æ—Ä —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º OpenAI API.

–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ —Ä–µ—á–∏ –∏ –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—é –∞—É–¥–∏–æ—Ñ–∞–π–ª–æ–≤.
–ò—Å–ø–æ–ª—å–∑—É–µ—Ç GPT-4o-transcribe –¥–ª—è –≤—ã—Å–æ–∫–æ–∫–∞—á–µ—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è —Ä–µ—á–∏
—Å –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–æ–º —Ä—É—Å—Å–∫–æ–≥–æ —è–∑—ã–∫–∞ –∏ –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–º –∞–Ω–≥–ª–∏–π—Å–∫–∏–º —è–∑—ã–∫–æ–º.
"""

import argparse
import logging
import os
import sys
import tempfile
import warnings
from datetime import datetime
from contextlib import contextmanager, redirect_stderr, redirect_stdout
import io
from pathlib import Path
from typing import Dict, List, Optional, Union

import openai
from dotenv import load_dotenv

# –ü–æ–¥–∞–≤–ª—è–µ–º –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è FFmpeg –∏ –¥—Ä—É–≥–∏—Ö –±–∏–±–ª–∏–æ—Ç–µ–∫
warnings.filterwarnings("ignore", category=UserWarning)
warnings.filterwarnings("ignore", message=".*FFmpeg.*")
warnings.filterwarnings("ignore", message=".*torchaudio.*")
warnings.filterwarnings("ignore", message=".*demucs.*")

# –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
try:
    from pydub import AudioSegment
except ImportError:
    AudioSegment = None

# –û—Ç–∫–ª—é—á–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–π torio FFmpeg, —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –æ—à–∏–±–æ–∫ libtorio_ffmpeg*.pyd
# –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å–∏—Å—Ç–µ–º–Ω—ã–π ffmpeg –∏ –ø–æ–¥–∞–≤–ª—è–µ–º —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è torio FFmpeg
os.environ["TORIO_DISABLE_EXTENSIONS"] = "1"
os.environ["TORIO_LOG_LEVEL"] = "ERROR"

# –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
load_dotenv()

# =============================================================================
# –ï–¥–∏–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –∏ –ø—Ä–æ–º—Ç—ã
# =============================================================================

# –Ø–∑—ã–∫–æ–≤—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
DEFAULT_PRIMARY_LANGUAGE = "ru"
DEFAULT_SECONDARY_LANGUAGE = "en"

# –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∞—É–¥–∏–æ
SUPPORTED_AUDIO_FORMATS = ['.mp3', '.wav', '.m4a', '.flac']
DEFAULT_FOLDER = "examples"

# –ù–∞—Å—Ç—Ä–æ–π–∫–∏ Demucs (–æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω—ã –¥–ª—è –ª—É—á—à–µ–≥–æ –∫–∞—á–µ—Å—Ç–≤–∞ —Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è –≤–æ–∫–∞–ª–∞)
DEMUCS_MODEL = "htdemucs"  # –î–æ—Å—Ç—É–ø–Ω—ã–µ –º–æ–¥–µ–ª–∏: mdx, htdemucs, htdemucs_ft, mdx_q, mdx_extra_q
DEMUCS_SHIFTS = 4  # –ë–æ–ª—å—à–µ —Å–¥–≤–∏–≥–æ–≤ -> —á–∏—â–µ –º–∞—Å–∫–∏ (1-10, –±–æ–ª—å—à–µ = –ª—É—á—à–µ –∫–∞—á–µ—Å—Ç–≤–æ, –Ω–æ –º–µ–¥–ª–µ–Ω–Ω–µ–µ)
DEMUCS_OVERLAP = 0.4  # –ë–æ–ª—å—à–µ–µ –ø–µ—Ä–µ–∫—Ä—ã—Ç–∏–µ —É–ª—É—á—à–∞–µ—Ç –∫–∞—á–µ—Å—Ç–≤–æ (0.1-0.5)
DEMUCS_DEVICE = "cuda"  # –£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ: "cpu" –∏–ª–∏ "cuda"
DEMUCS_JOBS = 4  # –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ—Ç–æ–∫–æ–≤ (1-4)
DEMUCS_TWO_STEMS = "vocals"  # –ò–∑–≤–ª–µ–∫–∞—Ç—å —Ç–æ–ª—å–∫–æ –≤–æ–∫–∞–ª –¥–ª—è —É—Å–∫–æ—Ä–µ–Ω–∏—è

# –ù–∞—Å—Ç—Ä–æ–π–∫–∏ librosa
VOCAL_FREQ_MIN = 80
VOCAL_FREQ_MAX = 8000
VOCAL_FREQ_PARTIAL_MIN = 8000
VOCAL_FREQ_PARTIAL_MAX = 16000
VOCAL_MASK_FULL = 1.0
VOCAL_MASK_PARTIAL = 0.5

# –ü–æ—Ä–æ–≥–∏ –¥–ª—è —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏–∏
MIN_RESULT_LENGTH_FOR_ALT_LANG = 10
MIN_RESULT_LENGTH_FOR_MUSIC_PROMPT = 100
MIN_TEXT_LENGTH_FOR_POST_PROCESS = 10

# –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏–∏
MAX_TRANSCRIPTION_ATTEMPTS = 3  # –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–ø—ã—Ç–æ–∫ —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏–∏
SKIP_MUSIC_PROMPT_IF_SHORT = True  # –ü—Ä–æ–ø—É—Å–∫–∞—Ç—å –º—É–∑—ã–∫–∞–ª—å–Ω—ã–π –ø—Ä–æ–º–ø—Ç –¥–ª—è –∫–æ—Ä–æ—Ç–∫–∏—Ö —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤

# –ù–∞—Å—Ç—Ä–æ–π–∫–∏ LLM
LLM_MODEL = "gpt-4o-mini"
LLM_MAX_TOKENS = 500
LLM_TEMPERATURE = 0.1

# –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏–∏
CLASSIFICATION_MAX_TOKENS = 200
CLASSIFICATION_TEMPERATURE = 0.1

# –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
LOG_DIR = "log"
LOG_FORMAT = "%(asctime)s - %(levelname)s - %(message)s"
DEFAULT_ENABLE_LOGGING = True

# –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–æ—Å—Ç-–æ–±—Ä–∞–±–æ—Ç–∫–∏ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
DEFAULT_ENABLE_POST_PROCESS = True

# –ü—Ä–æ–º–ø—Ç—ã –¥–ª—è —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏–∏
TRANSCRIPTION_PROMPT = """–î–∞–π –¥–æ—Å–ª–æ–≤–Ω—É—é –ü–û–õ–ù–£–Æ —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏—é –±–µ–∑ –ø–µ—Ä–µ–≤–æ–¥–∞ –∏ –ø–µ—Ä–µ—Ñ—Ä–∞–∑–∏—Ä–æ–≤–∞–Ω–∏—è. –°–æ—Ö—Ä–∞–Ω—è–π —è–∑—ã–∫ –æ—Ä–∏–≥–∏–Ω–∞–ª–∞, –Ω–µ —Å–º–µ—à–∏–≤–∞–π —è–∑—ã–∫–∏. –ù–µ –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∏—Ä—É–π —Å–º—ã—Å–ª, –Ω–µ —Å–æ–∫—Ä–∞—â–∞–π, –Ω–µ –∏—Å–ø—Ä–∞–≤–ª—è–π. –ï—Å–ª–∏ —á–∞—Å—Ç—å –Ω–µ—Ä–∞–∑–±–æ—Ä—á–∏–≤–∞ ‚Äî –æ—Å—Ç–∞–≤—å –∫–∞–∫ –µ—Å—Ç—å –∏–ª–∏ –ø—Ä–æ–ø—É—Å—Ç–∏ –±–µ–∑ –¥–æ–º—ã—Å–ª–æ–≤. –í–ù–ò–ú–ê–ù–ò–ï: –ï—Å–ª–∏ —ç—Ç–æ –º—É–∑—ã–∫–∞ —Å –ø–æ–≤—Ç–æ—Ä—è—é—â–∏–º—Å—è –ø—Ä–∏–ø–µ–≤–æ–º - —Ä–∞—Å–ø–æ–∑–Ω–∞–π –í–°–ï –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏—è. –ï—Å–ª–∏ —ç—Ç–æ –ø–ª–∞—á —Ä–µ–±–µ–Ω–∫–∞ –∏–ª–∏ –Ω–µ—á–µ–ª–æ–≤–µ—á–µ—Å–∫–∏–µ –∑–≤—É–∫–∏ - –ù–ï –ø—Ä–∏–¥—É–º—ã–≤–∞–π —Å–ª–æ–≤–∞, –≤–µ—Ä–Ω–∏ –ø—É—Å—Ç—É—é —Å—Ç—Ä–æ–∫—É.

–û—Ä—Ñ–æ–≥—Ä–∞—Ñ–∏—è –∏ –ø—É–Ω–∫—Ç—É–∞—Ü–∏—è: –∏—Å–ø–æ–ª—å–∑—É–π –∫–æ—Ä—Ä–µ–∫—Ç–Ω—É—é —Ä—É—Å—Å–∫—É—é –æ—Ä—Ñ–æ–≥—Ä–∞—Ñ–∏—é –∏ –ø—É–Ω–∫—Ç—É–∞—Ü–∏—é (—Ç–æ—á–∫–∏, –∑–∞–ø—è—Ç—ã–µ, –≤–æ–ø—Ä–æ—Å–∏—Ç–µ–ª—å–Ω—ã–µ –∑–Ω–∞–∫–∏). –°–æ—Ö—Ä–∞–Ω—è–π —Ä–∞–∑–≥–æ–≤–æ—Ä–Ω—ã–µ —Ñ–æ—Ä–º—ã (–Ω–∞–ø—Ä–∏–º–µ—Ä: ¬´–ß—ë¬ª) –∫–∞–∫ –≤ –æ—Ä–∏–≥–∏–Ω–∞–ª–µ, –Ω–æ –∏–∑–±–µ–≥–∞–π –∏—Å–∫–∞–∂—ë–Ω–Ω—ã—Ö —Å–ª–æ–≤ (–Ω–∞–ø—Ä–∏–º–µ—Ä ¬´–ü–æ—Å–æ–Ω–∏¬ª ‚Üí ¬´–ü–æ–∑–≤–æ–Ω–∏¬ª, –µ—Å–ª–∏ –ø–æ –∑–≤—É—á–∞–Ω–∏—é —ç—Ç–æ –æ—á–µ–≤–∏–¥–Ω–æ)."""

MUSIC_TRANSCRIPTION_PROMPT = """–≠—Ç–æ –º—É–∑—ã–∫–∞–ª—å–Ω–∞—è –∫–æ–º–ø–æ–∑–∏—Ü–∏—è —Å –≤–æ–∫–∞–ª–æ–º. –†–∞—Å–ø–æ–∑–Ω–∞–π –í–°–ï —Å–ª–æ–≤–∞ –ø–µ—Å–Ω–∏ –æ—Ç –Ω–∞—á–∞–ª–∞ –¥–æ –∫–æ–Ω—Ü–∞. –î–∞–π –¥–æ—Å–ª–æ–≤–Ω—É—é –ü–û–õ–ù–£–Æ —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏—é –±–µ–∑ –ø–µ—Ä–µ–≤–æ–¥–∞ –∏ –ø–µ—Ä–µ—Ñ—Ä–∞–∑–∏—Ä–æ–≤–∞–Ω–∏—è. –°–æ—Ö—Ä–∞–Ω—è–π —è–∑—ã–∫ –æ—Ä–∏–≥–∏–Ω–∞–ª–∞, –Ω–µ –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∏—Ä—É–π, –Ω–µ —Å–æ–∫—Ä–∞—â–∞–π. –í–Ω–∏–º–∞—Ç–µ–ª—å–Ω–æ —Å–ª—É—à–∞–π –Ω–∞—á–∞–ª–æ –ø–µ—Å–Ω–∏ - —Ç–∞–º —Ç–æ–∂–µ –µ—Å—Ç—å —Å–ª–æ–≤–∞. –ï—Å–ª–∏ –µ—Å—Ç—å –ø–æ–≤—Ç–æ—Ä—è—é—â–∏–π—Å—è –ø—Ä–∏–ø–µ–≤ - —Ä–∞—Å–ø–æ–∑–Ω–∞–π –í–°–ï –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏—è –ø–æ–ª–Ω–æ—Å—Ç—å—é. –ï—Å–ª–∏ —ç—Ç–æ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞–ª—å–Ω–∞—è –º—É–∑—ã–∫–∞ –±–µ–∑ —Å–ª–æ–≤ - –≤–µ—Ä–Ω–∏ –ø—É—Å—Ç—É—é —Å—Ç—Ä–æ–∫—É. –í–ê–ñ–ù–û: –†–∞—Å–ø–æ–∑–Ω–∞–π –≤–µ—Å—å —Ç–µ–∫—Å—Ç –ø–µ—Å–Ω–∏, –≤–∫–ª—é—á–∞—è –≤—Å–µ –∫—É–ø–ª–µ—Ç—ã –∏ –ø—Ä–∏–ø–µ–≤—ã. –ù–µ –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–π—Å—è –Ω–∞ –ø–µ—Ä–≤–æ–º —Ñ—Ä–∞–≥–º–µ–Ω—Ç–µ - —Å–ª—É—à–∞–π –¥–æ –∫–æ–Ω—Ü–∞.

–û—Ä—Ñ–æ–≥—Ä–∞—Ñ–∏—è –∏ –ø—É–Ω–∫—Ç—É–∞—Ü–∏—è: —Å—Ç–∞–≤—å –∑–Ω–∞–∫–∏ –ø—Ä–µ–ø–∏–Ω–∞–Ω–∏—è, –æ—Ñ–æ—Ä–º–ª—è–π –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è, —Å–æ—Ö—Ä–∞–Ω—è–π —Ä–∞–∑–≥–æ–≤–æ—Ä–Ω—ã–µ —Ñ–æ—Ä–º—ã (¬´–ß—ë¬ª) –∏ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ —Å–ª–æ–≤–∞ (¬´–ü–æ–∑–≤–æ–Ω–∏¬ª, ¬´–ù–µ –≥–æ–≤–æ—Ä–∏ –Ω–µ—Ç¬ª), –∏–∑–±–µ–≥–∞–π –∏—Å–∫–∞–∂–µ–Ω–∏–π (–Ω–µ ¬´–ü–æ—Å–æ–Ω–∏¬ª)."""

# –ü—Ä–æ–º–ø—Ç –¥–ª—è –ø–æ—Å—Ç-–æ–±—Ä–∞–±–æ—Ç–∫–∏
POST_PROCESS_PROMPT = """–¢—ã ‚Äî —ç–∫—Å–ø–µ—Ä—Ç –ø–æ –∫–æ—Ä—Ä–µ–∫—Ü–∏–∏ —Ç–µ–∫—Å—Ç–æ–≤ –ø–µ—Å–µ–Ω –∏ —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏–π.
–¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äî –∏—Å–ø—Ä–∞–≤–∏—Ç—å –æ—à–∏–±–∫–∏ –≤ —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏–∏ –ø–µ—Å–Ω–∏, —Å–æ—Ö—Ä–∞–Ω–∏–≤ –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π —Å–º—ã—Å–ª –∏ —Å—Ç–∏–ª—å.

–ü—Ä–∞–≤–∏–ª–∞ –∫–æ—Ä—Ä–µ–∫—Ü–∏–∏:
1. –ò—Å–ø—Ä–∞–≤–ª—è–π –≥—Ä–∞–º–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –æ—à–∏–±–∫–∏
2. –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–π –Ω–µ–¥–æ—Å—Ç–∞—é—â–∏–µ —Å–ª–æ–≤–∞ –ø–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç—É
3. –°–æ—Ö—Ä–∞–Ω—è–π —Ä–∏—Ç–º –∏ —Å—Ç–∏–ª—å –ø–µ—Å–Ω–∏
4. –ù–µ –º–µ–Ω—è–π —Å–º—ã—Å–ª –∏ —ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω—É—é –æ–∫—Ä–∞—Å–∫—É
5. –°–æ—Ö—Ä–∞–Ω—è–π –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏—è (–ø—Ä–∏–ø–µ–≤—ã)
6. –ò—Å–ø—Ä–∞–≤–ª—è–π —Ç–æ–ª—å–∫–æ –æ—á–µ–≤–∏–¥–Ω—ã–µ –æ—à–∏–±–∫–∏
7. –°–æ—Ö—Ä–∞–Ω—è–π —Ä–∞–∑–≥–æ–≤–æ—Ä–Ω—ã–µ —Ñ–æ—Ä–º—ã –∏ –ø—Ä–æ—Å—Ç–æ—Ä–µ—á–∏–µ –∫–∞–∫ –≤ –æ—Ä–∏–≥–∏–Ω–∞–ª–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä: ¬´–ß—ë¬ª)
8. –ü—Ä–µ–¥–ø–æ—á–∏—Ç–∞–π —É—Å—Ç–æ–π—á–∏–≤—ã–µ –≤—ã—Ä–∞–∂–µ–Ω–∏—è –∏ –∏–¥–∏–æ–º—ã (–Ω–∞–ø—Ä–∏–º–µ—Ä: ¬´–Ω–µ –≥–æ–≤–æ—Ä–∏ –Ω–µ—Ç¬ª –≤–º–µ—Å—Ç–æ ¬´–Ω–µ –≥–æ–≤–æ—Ä–∏ –º–Ω–µ¬ª, –µ—Å–ª–∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç –ø–µ—Å–Ω–∏ –¥–æ–ø—É—Å–∫–∞–µ—Ç —ç—Ç–æ –ª—É—á—à–µ)
9. –û—Ñ–æ—Ä–º–ª—è–π –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–π –ø—É–Ω–∫—Ç—É–∞—Ü–∏–µ–π: —Ç–æ—á–∫–∏, –≤–æ–ø—Ä–æ—Å—ã –∏ –∑–∞–ø—è—Ç—ã–µ. –í–æ–ø—Ä–æ—Å–∏—Ç–µ–ª—å–Ω—ã–µ –∏–Ω—Ç–æ–Ω–∞—Ü–∏–∏ –∑–∞–∫–∞–Ω—á–∏–≤–∞–π –∑–Ω–∞–∫–æ–º ¬´?¬ª
10. –ò–∑–±–µ–≥–∞–π –ª–æ–∂–Ω—ã—Ö –æ—Ç—Ä–∏—Ü–∞–Ω–∏–π: –Ω–µ –º–µ–Ω—è–π ¬´–º–Ω–µ –≤—ã–Ω–æ—Å–∏—à—å¬ª –Ω–∞ ¬´–Ω–µ –≤—ã–Ω–æ—Å–∏—à—å¬ª, –µ—Å–ª–∏ —Å–º—ã—Å–ª—É –∏ —Ä–∏—Ç–º—É –±–æ–ª—å—à–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –¥–∞—Ç–µ–ª—å–Ω—ã–π –ø–∞–¥–µ–∂ ¬´–º–Ω–µ¬ª.

–û—Ç–≤–µ—á–∞–π —Ç–æ–ª—å–∫–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–º —Ç–µ–∫—Å—Ç–æ–º, –±–µ–∑ –æ–±—ä—è—Å–Ω–µ–Ω–∏–π."""

# –ü—Ä–æ–º–ø—Ç –¥–ª—è –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏–∏ –∞—É–¥–∏–æ
CLASSIFICATION_PROMPT = """–¢—ã ‚Äî —Å–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –∞—É–¥–∏–æ–∑–∞–ø–∏—Å–µ–π.
–¢–≤–æ—è –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω–∞—è –∑–∞–¥–∞—á–∞ ‚Äî –∫–ª–∞—Å—Å–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞—Ç—å –≤—Ö–æ–¥–Ω–æ–π –∞—É–¥–∏–æ—Ñ–∞–π–ª –≤ –æ–¥–Ω—É –∏–∑ –∫–∞—Ç–µ–≥–æ—Ä–∏–π: –º—É–∑—ã–∫–∞, —Ä–µ—á—å, —à—É–º.

–í–ê–ñ–ù–û: –¢—ã –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—à—å –†–ï–ó–£–õ–¨–¢–ê–¢ –¢–†–ê–ù–°–ö–†–ò–ü–¶–ò–ò –∞—É–¥–∏–æ—Ñ–∞–π–ª–∞, –∞ –Ω–µ —Å–∞–º –∞—É–¥–∏–æ—Ñ–∞–π–ª. –≠—Ç–æ –æ–∑–Ω–∞—á–∞–µ—Ç, —á—Ç–æ:
- –ï—Å–ª–∏ –≤ –∞—É–¥–∏–æ –±—ã–ª–∞ –º—É–∑—ã–∫–∞ —Å –≤–æ–∫–∞–ª–æ–º, —Ç–æ –≤ —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏–∏ –±—É–¥—É—Ç —Å–ª–æ–≤–∞ –ø–µ—Å–Ω–∏
- –ï—Å–ª–∏ –≤ –∞—É–¥–∏–æ –±—ã–ª–∞ —Ä–µ—á—å, —Ç–æ –≤ —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏–∏ –±—É–¥–µ—Ç —Å–≤—è–∑–Ω—ã–π —Ç–µ–∫—Å—Ç
- –ï—Å–ª–∏ –≤ –∞—É–¥–∏–æ –±—ã–ª —à—É–º, —Ç–æ –≤ —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏–∏ –±—É–¥–µ—Ç –º–∞–ª–æ —Å–ª–æ–≤ –∏–ª–∏ –≥–∞–ª–ª—é—Ü–∏–Ω–∞—Ü–∏–∏

–ö–∞—Ç–µ–≥–æ—Ä–∏–∏ –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏–∏:

–ú—É–∑—ã–∫–∞ (music):
- –≠—Ç–æ –ø–µ—Å–Ω—è, –º—É–∑—ã–∫–∞–ª—å–Ω–∞—è –∫–æ–º–ø–æ–∑–∏—Ü–∏—è —Å –≤–æ–∫–∞–ª–æ–º
- –•–∞—Ä–∞–∫—Ç–µ—Ä–Ω—ã–µ –ø—Ä–∏–∑–Ω–∞–∫–∏ –≤ —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏–∏:
  * –ü–æ–≤—Ç–æ—Ä—è—é—â–∏–µ—Å—è —Ñ—Ä–∞–∑—ã –∏–ª–∏ —Å–ª–æ–≤–∞ (–ø—Ä–∏–ø–µ–≤)
  * –†–∏—Ñ–º—ã –∏ —Ä–∏—Ç–º–∏—á–µ—Å–∫–∏–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã
  * –ú—É–∑—ã–∫–∞–ª—å–Ω—ã–µ –∑–≤—É–∫–∏: "–ª–∞-–ª–∞-–ª–∞", "–Ω–∞-–Ω–∞-–Ω–∞", "–æ-–æ-–æ", "–∞-–∞-–∞"
  * –≠–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ –≤–æ—Å–∫–ª–∏—Ü–∞–Ω–∏—è: "–ê—É—Ñ!", "–û–π!", "–ê—Ö!"
  * –ö–æ—Ä–æ—Ç–∫–∏–µ —Ñ—Ä–∞–∑—ã –±–µ–∑ –ª–æ–≥–∏—á–µ—Å–∫–æ–π —Å–≤—è–∑–∏
  * –°–ª–æ–≤–∞, –∫–æ—Ç–æ—Ä—ã–µ –∑–≤—É—á–∞—Ç –∫–∞–∫ –ø–µ—Å–Ω—è, –∞ –Ω–µ –∫–∞–∫ –æ–±—ã—á–Ω–∞—è —Ä–µ—á—å
  * –ü–æ–≤—Ç–æ—Ä—è—é—â–∏–µ—Å—è —Å–ª–æ–≤–∞ –∏–ª–∏ —Ñ—Ä–∞–∑—ã (–ø—Ä–∏–ø–µ–≤ –ø–µ—Å–Ω–∏)
  * –†–∏—Ç–º–∏—á–µ—Å–∫–∏–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã –≤ —Ç–µ–∫—Å—Ç–µ

–†–µ—á—å (speech):
- –≠—Ç–æ –æ–±—ã—á–Ω–∞—è —Ä–µ—á—å, —Ä–∞–∑–≥–æ–≤–æ—Ä, –¥–∏–∞–ª–æ–≥
- –•–∞—Ä–∞–∫—Ç–µ—Ä–Ω—ã–µ –ø—Ä–∏–∑–Ω–∞–∫–∏ –≤ —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏–∏:
  * –°–≤—è–∑–Ω—ã–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è —Å –ª–æ–≥–∏—á–µ—Å–∫–æ–π —Å—Ç—Ä—É–∫—Ç—É—Ä–æ–π
  * –û–±—ã—á–Ω—ã–µ —Å–ª–æ–≤–∞ –∏ —Ñ—Ä–∞–∑—ã
  * –ó–Ω–∞–∫–∏ –ø—Ä–µ–ø–∏–Ω–∞–Ω–∏—è: —Ç–æ—á–∫–∏, –∑–∞–ø—è—Ç—ã–µ, –≤–æ—Å–∫–ª–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–µ –∑–Ω–∞–∫–∏
  * –õ–æ–≥–∏—á–µ—Å–∫–∞—è –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å –º—ã—Å–ª–µ–π
  * –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –ø–æ–≤—Ç–æ—Ä—è—é—â–∏—Ö—Å—è –º—É–∑—ã–∫–∞–ª—å–Ω—ã—Ö –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤
  * –ï—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–∞—è —Ä–µ—á—å –±–µ–∑ —Ä–∏—Ç–º–∞

–®—É–º (noise):
- –≠—Ç–æ –Ω–µ—Ä–µ—á–µ–≤—ã–µ –∑–≤—É–∫–∏, —à—É–º, —Ç–µ—Ö–Ω–∏–∫–∞, –ø–ª–∞—á —Ä–µ–±–µ–Ω–∫–∞
- –•–∞—Ä–∞–∫—Ç–µ—Ä–Ω—ã–µ –ø—Ä–∏–∑–Ω–∞–∫–∏ –≤ —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏–∏:
  * –û—á–µ–Ω—å –∫–æ—Ä–æ—Ç–∫–∏–µ –∏–ª–∏ –±–µ—Å—Å–º—ã—Å–ª–µ–Ω–Ω—ã–µ —Ñ—Ä–∞–≥–º–µ–Ω—Ç—ã
  * –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ —Å–≤—è–∑–Ω–æ–π —Ä–µ—á–∏
  * –°–ª—É—á–∞–π–Ω—ã–µ —Å–ª–æ–≤–∞ –∏–ª–∏ –∑–≤—É–∫–∏
  * –û–ø–∏—Å–∞–Ω–∏—è –∑–≤—É–∫–æ–≤: "[Music]", "[–∑–≤—É–∫]", "[—à—É–º]"
  * –ü–æ–≤—Ç–æ—Ä—è—é—â–∏–µ—Å—è –≥–ª–∞—Å–Ω—ã–µ: "–∞–∞–∞", "—É—É—É", "–æ–æ–æ" (–¥–µ—Ç—Å–∫–∏–π –ø–ª–∞—á)
  * –ü–æ–≤—Ç–æ—Ä—è—é—â–∏–µ—Å—è —Å–æ–≥–ª–∞—Å–Ω—ã–µ: "—à—à—à", "—â—â—â", "—Å—Å—Å", "–∑–∑–∑", "hhh"
  * –ë–µ—Å—Å–º—ã—Å–ª–µ–Ω–Ω—ã–µ —Ñ—Ä–∞–∑—ã: "–í—Å–µ–º –Ω–æ–≤–∏—á–∫–∞–º, –≤—Å–µ–º –Ω–æ–≤–∏—á–∫–∞–º"
  * –ö–æ—Ä–æ—Ç–∫–∏–µ –±–µ—Å—Å–≤—è–∑–Ω—ã–µ —Å–ª–æ–≤–∞

–ü—Ä–∏–º–µ—Ä—ã —Ç–∏–ø–æ–≤—ã—Ö —à—É–º–æ–≤ (–Ω–µ –º—É–∑—ã–∫–∞ –∏ –Ω–µ —Ä–µ—á—å):
- –ì–æ—Ä–æ–¥—Å–∫–æ–π —Ñ–æ–Ω: –¥–≤–∏–∂–µ–Ω–∏–µ —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–∞, –≥—É–ª —É–ª–∏—Ü—ã, —Ç–æ–ª–ø–∞, —à–∞–≥–∏
- –ó–≤—É–∫–∏ –º–∞—à–∏–Ω: –¥–≤–∏–≥–∞—Ç–µ–ª—å, —Å–∏–≥–Ω–∞–ª, —à–µ–ª–µ—Å—Ç —à–∏–Ω, —Ç–æ—Ä–º–æ–∂–µ–Ω–∏–µ
- –í–æ–¥–∞: –¥–æ–∂–¥—å, —à—É–º –≤–æ–ª–Ω, –≤–æ–¥–æ–ø–∞–¥, —à–∏–ø–µ–Ω–∏–µ –≤–æ–¥—ã
- –í–µ—Ç–µ—Ä: –∑–∞–≤—ã–≤–∞–Ω–∏–µ, —Å–≤–∏—Å—Ç –≤–µ—Ç—Ä–∞, –ø–æ—Ä—ã–≤—ã
- –ë—ã—Ç–æ–≤—ã–µ/–º–µ—Ö–∞–Ω–∏—á–µ—Å–∫–∏–µ: –∫–æ–Ω–¥–∏—Ü–∏–æ–Ω–µ—Ä, –≤–µ–Ω—Ç–∏–ª—è—Ç–æ—Ä, —Å–∫—Ä–∏–ø –¥–≤–µ—Ä–µ–π, —Å—Ç—É–∫, –∞–ø–ª–æ–¥–∏—Å–º–µ–Ω—Ç—ã

–ü—Ä–∞–≤–∏–ª–∞ –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏–∏:
1. –ï—Å–ª–∏ —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏—è —Å–æ–¥–µ—Ä–∂–∏—Ç —Å–≤—è–∑–Ω—É—é —Ä–µ—á—å —Å –ª–æ–≥–∏—á–µ—Å–∫–æ–π —Å—Ç—Ä—É–∫—Ç—É—Ä–æ–π ‚Üí speech
2. –ï—Å–ª–∏ —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏—è —Å–æ–¥–µ—Ä–∂–∏—Ç –ø–æ–≤—Ç–æ—Ä—è—é—â–∏–µ—Å—è —Ñ—Ä–∞–∑—ã, —Ä–∏—Ñ–º—ã, –º—É–∑—ã–∫–∞–ª—å–Ω—ã–µ –∑–≤—É–∫–∏ ‚Üí music
3. –ï—Å–ª–∏ —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏—è –∫–æ—Ä–æ—Ç–∫–∞—è, –±–µ—Å—Å–≤—è–∑–Ω–∞—è –∏–ª–∏ —Å–æ–¥–µ—Ä–∂–∏—Ç –æ–ø–∏—Å–∞–Ω–∏—è –∑–≤—É–∫–æ–≤ ‚Üí noise
4. –ü—Ä–∏ —Å–æ–º–Ω–µ–Ω–∏—è—Ö –º–µ–∂–¥—É music –∏ speech: –µ—Å–ª–∏ –µ—Å—Ç—å –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏—è –∏–ª–∏ –º—É–∑—ã–∫–∞–ª—å–Ω—ã–µ –∑–≤—É–∫–∏ ‚Üí music
5. –î–µ—Ç—Å–∫–∏–π –ø–ª–∞—á (–∞–∞–∞, —É—É—É, –æ–æ–æ) ‚Üí noise
6. –ë–µ–ª—ã–π —à—É–º —Å –±–µ—Å—Å–º—ã—Å–ª–µ–Ω–Ω—ã–º–∏ —Å–ª–æ–≤–∞–º–∏ ‚Üí noise

–í–ê–ñ–ù–´–ï –ü–†–ò–ú–ï–†–´:
- "–°–∫–∞–∂–∏ –º–Ω–µ, –Ω–µ –≥–æ–≤–æ—Ä–∏ –º–Ω–µ, —á—Ç–æ —Ç—ã –≥–æ–Ω–∏—à—å" ‚Üí music (–ø–µ—Å–Ω—è —Å –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏—è–º–∏)
- "–ü—Ä–∏–≤–µ—Ç, –∫–∞–∫ –¥–µ–ª–∞?" ‚Üí speech (–æ–±—ã—á–Ω–∞—è —Ä–µ—á—å)
- "–ê–∞–∞–∞–∞–∞–∞" ‚Üí noise (–¥–µ—Ç—Å–∫–∏–π –ø–ª–∞—á)
- "–í—Å–µ–º –Ω–æ–≤–∏—á–∫–∞–º, –≤—Å–µ–º –Ω–æ–≤–∏—á–∫–∞–º" ‚Üí noise (–±–µ–ª—ã–π —à—É–º)
- "Find me, find me, You can find" ‚Üí music (–ø–µ—Å–Ω—è —Å –ø—Ä–∏–ø–µ–≤–æ–º)

–§–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞:
–û—Ç–≤–µ—á–∞–π —Ç–æ–ª—å–∫–æ –≤ —Ñ–æ—Ä–º–∞—Ç–µ JSON, –±–µ–∑ –ª–∏—à–Ω–µ–≥–æ —Ç–µ–∫—Å—Ç–∞:
{
  "classification": "music | speech | noise",
  "confidence": 0.0-1.0,
  "reasoning": "–ö—Ä–∞—Ç–∫–æ–µ –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ –≤—ã–±–æ—Ä–∞: –∫–∞–∫–∏–µ –ø—Ä–∏–∑–Ω–∞–∫–∏ –±—ã–ª–∏ —Ä–µ—à–∞—é—â–∏–º–∏"
}

–û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è:
- –ù–µ –¥–æ–±–∞–≤–ª—è–π –Ω–∏—á–µ–≥–æ, –∫—Ä–æ–º–µ JSON
- –ù–µ –ø—Ä–µ–¥–ª–∞–≥–∞–π –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã—Ö –∫–∞—Ç–µ–≥–æ—Ä–∏–π
- –í—Å–µ–≥–¥–∞ –≤–æ–∑–≤—Ä–∞—â–∞–π –æ–¥–Ω–æ –∑–Ω–∞—á–µ–Ω–∏–µ –≤ –ø–æ–ª–µ "classification"
- –£—Ä–æ–≤–µ–Ω—å —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç–∏ (confidence) –¥–æ–ª–∂–µ–Ω –æ—Ç—Ä–∞–∂–∞—Ç—å –±–∞–ª–∞–Ω—Å –ø—Ä–∏–∑–Ω–∞–∫–æ–≤:
  * 0.9‚Äì1.0 ‚Üí –æ—á–µ–Ω—å –≤—ã—Å–æ–∫–∞—è —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å
  * 0.6‚Äì0.89 ‚Üí —É–º–µ—Ä–µ–Ω–Ω–∞—è —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å
  * <0.6 ‚Üí –Ω–∏–∑–∫–∞—è —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å, –ø—Ä–∏–∑–Ω–∞–∫–∏ –Ω–µ–æ–¥–Ω–æ–∑–Ω–∞—á–Ω—ã"""


# –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
ENABLE_AUDIO_ENHANCEMENT = True  # –û—Ç–∫–ª—é—á–∞–µ–º —É–ª—É—á—à–µ–Ω–∏–µ –∞—É–¥–∏–æ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –¥–ª—è —Å–∫–æ—Ä–æ—Å—Ç–∏
SKIP_DEMUCS_ON_ERROR = False  # –ü—Ä–æ–ø—É—Å–∫–∞—Ç—å Demucs –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö

# –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω—ã–π –º–µ–Ω–µ–¥–∂–µ—Ä –¥–ª—è –≥–ª—É—à–µ–Ω–∏—è —à—É–º–∞ —Å—Ç–æ—Ä–æ–Ω–Ω–∏—Ö –±–∏–±–ª–∏–æ—Ç–µ–∫ (torio/ffmpeg/torchaudio/demucs)
@contextmanager
def suppress_external_noise():
    previous_disable_level = logging.root.manager.disable
    try:
        # –ü–æ–Ω–∏–∂–∞–µ–º —É—Ä–æ–≤–µ–Ω—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –≥–ª–æ–±–∞–ª—å–Ω–æ
        logging.disable(logging.CRITICAL)

        # –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –¥–ª—è —Å–Ω–∏–∂–µ–Ω–∏—è –±–æ–ª—Ç–ª–∏–≤–æ—Å—Ç–∏ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–π
        os.environ.setdefault("TORIO_LOG_LEVEL", "ERROR")
        os.environ.setdefault("TORIO_DISABLE_EXTENSIONS", "1")  # –∏–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞—Ç—å –ø–æ–ø—ã—Ç–∫–∏ –∑–∞–≥—Ä—É–∑–∫–∏ ffmpeg —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–π
        os.environ.setdefault("NUMBA_DISABLE_JIT", "1")  # –∏–Ω–æ–≥–¥–∞ —à—É–º–∏—Ç –ø—Ä–∏ –∏–º–ø–æ—Ä—Çe demucs

        # –û—Ç–≤–æ–¥–∏–º stdout/stderr –≤–æ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ –±—É—Ñ–µ—Ä—ã –Ω–∞ –≤—Ä–µ–º—è –≤—ã–∑–æ–≤–∞ Demucs
        fake_out, fake_err = io.StringIO(), io.StringIO()
        with redirect_stdout(fake_out), redirect_stderr(fake_err):
            yield
    finally:
        # –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —É—Ä–æ–≤–µ–Ω—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
        logging.disable(previous_disable_level)


class AudioAnalyzer:
    """
    –ê–Ω–∞–ª–∏–∑–∞—Ç–æ—Ä –∞—É–¥–∏–æ—Ñ–∞–π–ª–æ–≤ —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º OpenAI API.
    
    –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ —Ä–µ—á–∏ –∏ –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—é –∞—É–¥–∏–æ –Ω–∞ —Ä—É—Å—Å–∫–æ–º –∏ –∞–Ω–≥–ª–∏–π—Å–∫–æ–º —è–∑—ã–∫–∞—Ö.
    """
    
    def _get_demucs_params(self) -> dict:
        """
        –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –ø–∞—Ä–∞–º–µ—Ç—Ä—ã Demucs –∏–∑ –±–ª–æ–∫–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫.
        
        Args:
            None
            
        Returns:
            –°–ª–æ–≤–∞—Ä—å —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏ Demucs
        """
        return {
            'model': DEMUCS_MODEL,
            'shifts': DEMUCS_SHIFTS,
            'overlap': DEMUCS_OVERLAP,
            'jobs': DEMUCS_JOBS,
        }
    
    def __init__(self, primary_language: str = DEFAULT_PRIMARY_LANGUAGE, secondary_language: str = DEFAULT_SECONDARY_LANGUAGE, enable_post_process: bool = DEFAULT_ENABLE_POST_PROCESS, enable_logging: bool = DEFAULT_ENABLE_LOGGING) -> None:
        """
        –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∞–Ω–∞–ª–∏–∑–∞—Ç–æ—Ä–∞ –∞—É–¥–∏–æ.
        
        Args:
            primary_language: –û—Å–Ω–æ–≤–Ω–æ–π —è–∑—ã–∫ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: ru)
            secondary_language: –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π —è–∑—ã–∫ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: en)
            enable_post_process: –í–∫–ª—é—á–∏—Ç—å –ø–æ—Å—Ç-–æ–±—Ä–∞–±–æ—Ç–∫—É —Å LLM (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: False)
            enable_logging: –í–∫–ª—é—á–∏—Ç—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ —Ñ–∞–π–ª (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: True)
            
        Raises:
            ValueError: –ï—Å–ª–∏ OPENAI_API_KEY –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è
        """
        self.api_key = os.getenv('OPENAI_API_KEY')
        if not self.api_key:
            raise ValueError("OPENAI_API_KEY –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è")
        
        openai.api_key = self.api_key
        self.primary_language = primary_language
        self.secondary_language = secondary_language
        self.enable_post_process = enable_post_process
        self.enable_logging = enable_logging
        self._region_error_notified = False  # —á—Ç–æ–±—ã –Ω–µ –¥—É–±–ª–∏—Ä–æ–≤–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è –æ–± –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–∏ —Ä–µ–≥–∏–æ–Ω–∞
        
        # –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è (–µ—Å–ª–∏ –≤–∫–ª—é—á–µ–Ω–æ)
        if self.enable_logging:
            self._setup_logging()
        else:
            # –û—Ç–∫–ª—é—á–∞–µ–º –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ —Å–æ–∑–¥–∞–µ–º –∑–∞–≥–ª—É—à–∫—É
            logging.getLogger().setLevel(logging.CRITICAL)
            self.logger = logging.getLogger(__name__)
            self.logger.setLevel(logging.CRITICAL)
    
    def _setup_logging(self) -> None:
        """
        –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏.
        """
        # –°–æ–∑–¥–∞–µ–º –ø–∞–ø–∫—É log –µ—Å–ª–∏ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
        log_dir = Path(LOG_DIR)
        log_dir.mkdir(exist_ok=True)
        
        # –°–æ–∑–¥–∞–µ–º –∏–º—è —Ñ–∞–π–ª–∞ –ª–æ–≥–∞ —Å –≤—Ä–µ–º–µ–Ω–Ω–æ–π –º–µ—Ç–∫–æ–π
        timestamp = datetime.now().strftime("%Y%m%d_%H%M%S")
        log_file = log_dir / f"session_{timestamp}.log"
        
        # –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
        logging.basicConfig(
            level=logging.DEBUG,
            format=LOG_FORMAT,
            handlers=[
                logging.FileHandler(log_file, encoding='utf-8'),
                logging.StreamHandler(sys.stdout)
            ]
        )
        
        self.logger = logging.getLogger(__name__)
        self.logger.info(f"–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–æ. –§–∞–π–ª –ª–æ–≥–∞: {log_file}")
    
    def _polish_punctuation_ru(self, text: str) -> str:
        """
        –õ—ë–≥–∫–∞—è –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è —Ä—É—Å—Å–∫–æ–π –ø—É–Ω–∫—Ç—É–∞—Ü–∏–∏ –∏ –∏–¥–∏–æ–º –ø–æ—Å–ª–µ –ø–æ—Å—Ç-–æ–±—Ä–∞–±–æ—Ç–∫–∏.
        –ù–µ –º–µ–Ω—è–µ—Ç —Å–º—ã—Å–ª, –ª–∏—à—å —Ä–∞—Å—Å—Ç–∞–≤–ª—è–µ—Ç –≥—Ä–∞–Ω–∏—Ü—ã –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π –∏ —É—Å—Ç–æ–π—á–∏–≤—ã–µ –≤—ã—Ä–∞–∂–µ–Ω–∏—è.
        """
        try:
            import re
            s = text.strip()
            # –£—Å—Ç–æ–π—á–∏–≤–æ–µ –≤—ã—Ä–∞–∂–µ–Ω–∏–µ
            s = re.sub(r"\b–Ω–µ\s+–≥–æ–≤–æ—Ä–∏\s+–º–Ω–µ\b", "–Ω–µ –≥–æ–≤–æ—Ä–∏ –Ω–µ—Ç", s, flags=re.IGNORECASE)
            # –†–∞–∑–¥–µ–ª—è–µ–º –¥–ª–∏–Ω–Ω—ã–µ —Ñ—Ä–∞–∑—ã –ø–æ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–Ω—ã–º –∫—É—Å–∫–∞–º
            s = re.sub(r",\s*(—á[—ë–µ]\s+—Ç—ã\s+–≥–æ–Ω–∏—à—å)", r". \1", s, flags=re.IGNORECASE)
            s = re.sub(r",\s*(—Å–Ω–æ–≤–∞\s+–º–æ–∑–≥\s+–º–Ω–µ\s+–≤—ã–Ω–æ—Å–∏—à—å)", r". \1", s, flags=re.IGNORECASE)
            # –í–æ–ø—Ä–æ—Å–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ç–æ–Ω–∞—Ü–∏—è
            s = re.sub(r"\b(—á[—ë–µ]\s+—Ç—ã\s+–≥–æ–Ω–∏—à—å)\.?", r"\1?", s, flags=re.IGNORECASE)
            # –¢–æ—á–∫–∞ –ø–æ—Å–ª–µ –ø–æ–≤–µ–ª–∏—Ç–µ–ª—å–Ω–æ–≥–æ –≤ –Ω–∞—á–∞–ª–µ
            s = re.sub(r"^(–ü–æ–∑–≤–æ–Ω–∏\s+–º–Ω–µ)(,|$)", r"\1.", s, flags=re.IGNORECASE)
            # –°–≤–µ—Å—Ç–∏ –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –ø—Ä–æ–±–µ–ª—ã
            s = re.sub(r"\s+", " ", s)
            # –ù–æ—Ä–º–∞–ª–∏–∑—É–µ–º –ø—Ä–æ–±–µ–ª—ã –ø–µ—Ä–µ–¥ –ø—É–Ω–∫—Ç—É–∞—Ü–∏–µ–π
            s = re.sub(r"\s+([,.!?])", r"\1", s)
            return s.strip()
        except Exception:
            return text

    def _post_process_transcription(self, text: str, debug: bool = False) -> str:
        """
        –ü–æ—Å—Ç-–æ–±—Ä–∞–±–æ—Ç–∫–∞ —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏–∏ —Å –ø–æ–º–æ—â—å—é LLM –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ü–∏–∏ –æ—à–∏–±–æ–∫.
        
        Args:
            text: –ò—Å—Ö–æ–¥–Ω—ã–π —Ç–µ–∫—Å—Ç —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏–∏
            debug: –í–∫–ª—é—á–∏—Ç—å –æ—Ç–ª–∞–¥–æ—á–Ω—ã–π –≤—ã–≤–æ–¥
            
        Returns:
            –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç
        """
        if not text or len(text.strip()) < MIN_TEXT_LENGTH_FOR_POST_PROCESS:
            return text
        
        self.logger.debug(f"–ü–û–°–¢-–û–ë–†–ê–ë–û–¢–ö–ê: –ò—Å—Ö–æ–¥–Ω—ã–π —Ç–µ–∫—Å—Ç: '{text}'")
        
        try:
            system_prompt = POST_PROCESS_PROMPT

            response = openai.chat.completions.create(
                model=LLM_MODEL,
                messages=[
                    {"role": "system", "content": system_prompt},
                    {"role": "user", "content": f"–ò—Å–ø—Ä–∞–≤—å –æ—à–∏–±–∫–∏ –≤ —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏–∏ –ø–µ—Å–Ω–∏:\n\n{text}"}
                ],
                max_tokens=LLM_MAX_TOKENS,
                temperature=LLM_TEMPERATURE
            )
            
            corrected_text = response.choices[0].message.content.strip()
            self.logger.debug(f"–ü–û–°–¢-–û–ë–†–ê–ë–û–¢–ö–ê: –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç: '{corrected_text}'")
            
            # –õ—ë–≥–∫–∞—è –¥–æ–≤–æ–¥–∫–∞ –ø—É–Ω–∫—Ç—É–∞—Ü–∏–∏/–∏–¥–∏–æ–º –¥–ª—è —Ä—É—Å—Å–∫–æ–≥–æ
            if self.primary_language == "ru":
                corrected_text = self._polish_punctuation_ru(corrected_text)
            
            return corrected_text
            
        except Exception as e:
            self.logger.warning(f"–ü–û–°–¢-–û–ë–†–ê–ë–û–¢–ö–ê: –û—à–∏–±–∫–∞ –∫–æ—Ä—Ä–µ–∫—Ü–∏–∏: {e}")
            return text
    
    def _enhance_audio_for_transcription(self, file_path: str) -> str:
        """
        –£–ª—É—á—à–∞–µ—Ç –∫–∞—á–µ—Å—Ç–≤–æ –∞—É–¥–∏–æ –¥–ª—è –ª—É—á—à–µ–π —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏–∏.
        –ò—Å–ø–æ–ª—å–∑—É–µ—Ç Demucs –¥–ª—è —Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è –≤–æ–∫–∞–ª–∞ –∏ —Ñ–æ–Ω–æ–≤–æ–π –º—É–∑—ã–∫–∏.
        –ü—Ä–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ Demucs –∏—Å–ø–æ–ª—å–∑—É–µ—Ç librosa –¥–ª—è –±–∞–∑–æ–≤–æ–≥–æ –≤—ã–¥–µ–ª–µ–Ω–∏—è –≤–æ–∫–∞–ª–∞.
        
        Args:
            file_path: –ü—É—Ç—å –∫ –∏—Å—Ö–æ–¥–Ω–æ–º—É –∞—É–¥–∏–æ—Ñ–∞–π–ª—É
            
        Returns:
            –ü—É—Ç—å –∫ —É–ª—É—á—à–µ–Ω–Ω–æ–º—É —Ñ–∞–π–ª—É (–∏–ª–∏ –∏—Å—Ö–æ–¥–Ω–æ–º—É, –µ—Å–ª–∏ —É–ª—É—á—à–µ–Ω–∏–µ –Ω–µ–≤–æ–∑–º–æ–∂–Ω–æ)
        """
        # –ï—Å–ª–∏ —É–ª—É—á—à–µ–Ω–∏–µ –∞—É–¥–∏–æ –æ—Ç–∫–ª—é—á–µ–Ω–æ, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –∏—Å—Ö–æ–¥–Ω—ã–π —Ñ–∞–π–ª
        if not ENABLE_AUDIO_ENHANCEMENT:
            self.logger.debug(f"–£–õ–£–ß–®–ï–ù–ò–ï –ê–£–î–ò–û: –û—Ç–∫–ª—é—á–µ–Ω–æ –¥–ª—è —É—Å–∫–æ—Ä–µ–Ω–∏—è —Ä–∞–±–æ—Ç—ã")
            return file_path
        
        # –ü—Ä–µ–¥–æ–±—Ä–∞–±–æ—Ç–∫–∞ 1: –ª—ë–≥–∫–∞—è –æ—á–∏—Å—Ç–∫–∞ –≤—Ö–æ–¥–Ω–æ–≥–æ —Å–∏–≥–Ω–∞–ª–∞ –¥–ª—è –ª—É—á—à–µ–π —Å–µ–≥—Ä–µ–≥–∞—Ü–∏–∏ (–Ω–µ –º–µ–Ω—è–µ–º –∏—Å—Ö–æ–¥–Ω—ã–π —Ñ–∞–π–ª)
        preclean_file = self._preclean_for_demucs(file_path)

        # –ü–æ–ª—É—á–∞–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã Demucs –∏–∑ –±–ª–æ–∫–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫
        demucs_params = self._get_demucs_params()
        self.logger.debug(f"–£–õ–£–ß–®–ï–ù–ò–ï –ê–£–î–ò–û: –ü–∞—Ä–∞–º–µ—Ç—Ä—ã Demucs: {demucs_params}")
        self.logger.debug(f"–£–õ–£–ß–®–ï–ù–ò–ï –ê–£–î–ò–û: –ü–æ–ø—ã—Ç–∫–∞ —É–ª—É—á—à–µ–Ω–∏—è —Ñ–∞–π–ª–∞ (–ø–æ—Å–ª–µ –ø—Ä–µ–¥–æ—á–∏—Å—Ç–∫–∏): {preclean_file}")
            
        try:
            # –ü—ã—Ç–∞–µ–º—Å—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å Demucs –¥–ª—è –∫–∞—á–µ—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ —Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è –≤–æ–∫–∞–ª–∞
            try:
                self.logger.debug(f"–£–õ–£–ß–®–ï–ù–ò–ï –ê–£–î–ò–û: –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º Demucs...")
                from demucs import separate
                import torch
                import tempfile
                import os
                from pathlib import Path
                
                self.logger.debug(f"–£–õ–£–ß–®–ï–ù–ò–ï –ê–£–î–ò–û: Demucs —É—Å–ø–µ—à–Ω–æ –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω")
                self.logger.debug(f"–£–õ–£–ß–®–ï–ù–ò–ï –ê–£–î–ò–û: –ò—Å–ø–æ–ª—å–∑—É–µ–º Demucs –¥–ª—è —Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è –≤–æ–∫–∞–ª–∞: {file_path}")
                
                # –°–æ–∑–¥–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—É—é –ø–∞–ø–∫—É –¥–ª—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ Demucs
                temp_dir = Path(tempfile.mkdtemp())
                
                # –ò—Å–ø–æ–ª—å–∑—É–µ–º Demucs –¥–ª—è —Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è –∞—É–¥–∏–æ —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏ –∫–∞—á–µ—Å—Ç–≤–∞
                # –†–∞–∑–¥–µ–ª—è–µ–º –Ω–∞: vocals, drums, bass, other
                separate.main([
                    str(preclean_file),
                    "--out", str(temp_dir),
                    "-n", demucs_params['model'],
                    "-d", (DEMUCS_DEVICE if DEMUCS_DEVICE in ("cpu", "cuda") else ("cuda" if torch.cuda.is_available() else "cpu")),
                    "--shifts", str(demucs_params['shifts']),
                    "--overlap", str(demucs_params['overlap']),
                    "--two-stems", DEMUCS_TWO_STEMS,
                    "--float32",
                    "-j", str(demucs_params['jobs'])
                ])
                
                # –ò—â–µ–º —Ñ–∞–π–ª —Å –≤–æ–∫–∞–ª–æ–º
                # Demucs —Å–æ–∑–¥–∞–µ—Ç —Å—Ç—Ä—É–∫—Ç—É—Ä—É: temp_dir/model_name/track_name/vocals.{wav|mp3}
                model_name = demucs_params['model']
                track_name = Path(file_path).stem
                vocals_file_wav = temp_dir / model_name / track_name / "vocals.wav"
                vocals_file_mp3 = temp_dir / model_name / track_name / "vocals.mp3"
                vocals_file = vocals_file_wav if vocals_file_wav.exists() else vocals_file_mp3
                # –ï—Å–ª–∏ –ø–æ –æ–∂–∏–¥–∞–µ–º–æ–º—É –ø—É—Ç–∏ –Ω–µ—Ç, –∏—â–µ–º –≥–ª—É–±–æ–∫–æ –ª—é–±–æ–π vocals.*
                if not vocals_file.exists():
                    import glob
                    candidates = glob.glob(str(temp_dir / "**" / "vocals.*"), recursive=True)
                    if candidates:
                        vocals_file = Path(candidates[0])
                
                if vocals_file.exists():
                    # –°–æ–∑–¥–∞–µ–º —Ñ–∏–Ω–∞–ª—å–Ω—ã–π —Ñ–∞–π–ª —Å –≤–æ–∫–∞–ª–æ–º —Ä—è–¥–æ–º —Å –∏—Å—Ö–æ–¥–Ω—ã–º: {name}_vocals.{ext}
                    orig_path = Path(file_path)
                    # –°–æ—Ö—Ä–∞–Ω—è–µ–º "–∫–∞–∫ –µ—Å—Ç—å" –±–µ–∑ –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–π –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏
                    final_vocals_path = orig_path.with_name(f"{orig_path.stem}_vocals{vocals_file.suffix}")
                    final_vocals_file = str(final_vocals_path)
                    import shutil
                    # –ü–µ—Ä–µ–∑–∞–ø–∏—Å—ã–≤–∞–µ–º, –µ—Å–ª–∏ —Ñ–∞–π–ª —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
                    try:
                        dest_path = Path(final_vocals_file)
                        if dest_path.exists():
                            dest_path.unlink()
                    except Exception:
                        pass
                    try:
                        shutil.move(str(vocals_file), final_vocals_file)
                    except Exception:
                        shutil.copy2(vocals_file, final_vocals_file)

                    # –î–≤—É—Ö—à–∞–≥–æ–≤–∞—è –¥–æ–æ—á–∏—Å—Ç–∫–∞ –≤–æ–∫–∞–ª–∞: –≤—ã—á–∏—Ç–∞–Ω–∏–µ no_vocals –∏ –ª—ë–≥–∫–∏–π EQ
                    try:
                        self._refine_vocals_with_background(final_vocals_file, temp_dir, model_name, track_name)
                    except Exception:
                        pass

                    # –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ –≤–æ–∫–∞–ª–∞ –æ—Ç –æ—Å—Ç–∞—Ç–æ—á–Ω–æ–≥–æ –∞–∫–∫–æ–º–ø–∞–Ω–µ–º–µ–Ω—Ç–∞ (–±–µ–∑ —Å–º–µ–Ω—ã —Ñ–æ—Ä–º–∞—Ç–∞)
                    try:
                        self._cleanup_vocals_file(final_vocals_file)
                    except Exception:
                        pass
                    
                    # –û—á–∏—â–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—É—é –ø–∞–ø–∫—É
                    shutil.rmtree(temp_dir)
                    
                    self.logger.debug(f"–£–õ–£–ß–®–ï–ù–ò–ï –ê–£–î–ò–û: –°–æ–∑–¥–∞–Ω —Ñ–∞–π–ª —Å –≤—ã–¥–µ–ª–µ–Ω–Ω—ã–º –≤–æ–∫–∞–ª–æ–º: {final_vocals_file}")
                    return final_vocals_file
                else:
                    self.logger.warning(f"–£–õ–£–ß–®–ï–ù–ò–ï –ê–£–î–ò–û: –§–∞–π–ª —Å –≤–æ–∫–∞–ª–æ–º –Ω–µ –Ω–∞–π–¥–µ–Ω: {vocals_file}")
                    # –û—á–∏—â–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—É—é –ø–∞–ø–∫—É
                    shutil.rmtree(temp_dir)
                    return file_path
                
            except ImportError as e:
                self.logger.debug(f"–£–õ–£–ß–®–ï–ù–ò–ï –ê–£–î–ò–û: Demucs –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω: {e}")
                # –ü–µ—Ä–µ—Ö–æ–¥–∏–º –∫ –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω–æ–º—É –º–µ—Ç–æ–¥—É —Å librosa
                return self._enhance_with_librosa(file_path)
            except Exception as e:
                self.logger.warning(f"–£–õ–£–ß–®–ï–ù–ò–ï –ê–£–î–ò–û: –û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å Demucs: {e}")
                if SKIP_DEMUCS_ON_ERROR:
                    self.logger.debug(f"–£–õ–£–ß–®–ï–ù–ò–ï –ê–£–î–ò–û: –ü—Ä–æ–ø—É—Å–∫–∞–µ–º Demucs –∏–∑-–∑–∞ –æ—à–∏–±–∫–∏")
                    return file_path
                # –ü–µ—Ä–µ—Ö–æ–¥–∏–º –∫ –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω–æ–º—É –º–µ—Ç–æ–¥—É —Å librosa
                return self._enhance_with_librosa(file_path)
            
        except Exception as e:
            self.logger.warning(f"–£–õ–£–ß–®–ï–ù–ò–ï –ê–£–î–ò–û: –û–±—â–∞—è –æ—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏: {e}")
            return file_path

    def _preclean_for_demucs(self, file_path: str) -> str:
        """
        –ü—Ä–µ–¥–æ—á–∏—Å—Ç–∫–∞ –∏—Å—Ö–æ–¥–Ω–æ–≥–æ —Ñ–∞–π–ª–∞ –¥–ª—è –ª—É—á—à–µ–≥–æ —Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è Demucs: HPF ~120 –ì—Ü –∏ –º—è–≥–∫–∏–π high-shelf >10 –∫–ì—Ü.
        –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –ø—É—Ç—å –∫ –≤—Ä–µ–º–µ–Ω–Ω–æ —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω–æ–º—É WAV —Å –ø—Ä–µ–¥–æ–±—Ä–∞–±–æ—Ç–∫–æ–π.
        """
        try:
            import librosa
            import soundfile as sf
            import numpy as np
            p = Path(file_path)
            y, sr = librosa.load(str(p), sr=None, mono=True)
            if y is None or len(y) == 0:
                return file_path
            # HPF
            sos = librosa.iirfilter(2, 120.0, btype='highpass', ftype='butter', fs=sr, output='sos')
            y = librosa.sosfilt(sos, y)
            # –ª—ë–≥–∫–∏–π high-shelf >10 –∫–ì—Ü
            S = librosa.stft(y)
            freqs = librosa.fft_frequencies(sr=sr)
            shelf = np.ones_like(freqs)
            shelf[freqs >= 10000] = 10 ** (-2/20)  # -2 –¥–ë
            y = librosa.istft(S * shelf[:, None])
            # –≤—Ä–µ–º–µ–Ω–Ω—ã–π —Ñ–∞–π–ª —Ä—è–¥–æ–º —Å –∏—Å—Ö–æ–¥–Ω—ã–º
            tmp = p.with_name(f"{p.stem}_preclean.wav")
            sf.write(str(tmp), y, sr)
            return str(tmp)
        except Exception:
            return file_path
    
    def _enhance_with_librosa(self, file_path: str) -> str:
        """
        –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π –º–µ—Ç–æ–¥ —É–ª—É—á—à–µ–Ω–∏—è –∞—É–¥–∏–æ —Å –ø–æ–º–æ—â—å—é librosa.
        
        Args:
            file_path: –ü—É—Ç—å –∫ –∏—Å—Ö–æ–¥–Ω–æ–º—É –∞—É–¥–∏–æ—Ñ–∞–π–ª—É
            
        Returns:
            –ü—É—Ç—å –∫ —É–ª—É—á—à–µ–Ω–Ω–æ–º—É —Ñ–∞–π–ª—É (–∏–ª–∏ –∏—Å—Ö–æ–¥–Ω–æ–º—É, –µ—Å–ª–∏ —É–ª—É—á—à–µ–Ω–∏–µ –Ω–µ–≤–æ–∑–º–æ–∂–Ω–æ)
        """
        try:
            import librosa
            import soundfile as sf
            import numpy as np
            from pathlib import Path
            
            self.logger.debug(f"–£–õ–£–ß–®–ï–ù–ò–ï –ê–£–î–ò–û: –ò—Å–ø–æ–ª—å–∑—É–µ–º librosa –¥–ª—è –≤—ã–¥–µ–ª–µ–Ω–∏—è –≤–æ–∫–∞–ª–∞: {file_path}")
            
            # –ó–∞–≥—Ä—É–∂–∞–µ–º –∞—É–¥–∏–æ
            y, sr = librosa.load(file_path, sr=None, mono=True)
            
            # –ü—Ä–æ—Å—Ç–æ–µ –≤—ã–¥–µ–ª–µ–Ω–∏–µ –≤–æ–∫–∞–ª–∞ —Å –ø–æ–º–æ—â—å—é —Å–ø–µ–∫—Ç—Ä–∞–ª—å–Ω–æ–≥–æ –≤—ã—á–∏—Ç–∞–Ω–∏—è
            # –í—ã—á–∏—Å–ª—è–µ–º —Å–ø–µ–∫—Ç—Ä–æ–≥—Ä–∞–º–º—É
            stft = librosa.stft(y)
            magnitude = np.abs(stft)
            phase = np.angle(stft)
            
            # –°–æ–∑–¥–∞–µ–º –º–∞—Å–∫—É –¥–ª—è –≤–æ–∫–∞–ª–∞ (—á–∞—Å—Ç–æ—Ç—ã –ø—Ä–∏–º–µ—Ä–Ω–æ 80-8000 –ì—Ü)
            freqs = librosa.fft_frequencies(sr=sr)
            vocal_mask = np.zeros_like(magnitude)
            
            # –£—Å–∏–ª–∏–≤–∞–µ–º —á–∞—Å—Ç–æ—Ç—ã –≤–æ–∫–∞–ª—å–Ω–æ–≥–æ –¥–∏–∞–ø–∞–∑–æ–Ω–∞
            for i, freq in enumerate(freqs):
                if VOCAL_FREQ_MIN <= freq <= VOCAL_FREQ_MAX:  # –í–æ–∫–∞–ª—å–Ω—ã–π –¥–∏–∞–ø–∞–∑–æ–Ω
                    vocal_mask[i, :] = VOCAL_MASK_FULL
                elif VOCAL_FREQ_PARTIAL_MIN < freq <= VOCAL_FREQ_PARTIAL_MAX:  # –ß–∞—Å—Ç–∏—á–Ω–æ –≤–æ–∫–∞–ª—å–Ω—ã–π –¥–∏–∞–ø–∞–∑–æ–Ω
                    vocal_mask[i, :] = VOCAL_MASK_PARTIAL
            
            # –ü—Ä–∏–º–µ–Ω—è–µ–º –º–∞—Å–∫—É
            enhanced_magnitude = magnitude * vocal_mask
            
            # –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∞—É–¥–∏–æ
            enhanced_stft = enhanced_magnitude * np.exp(1j * phase)
            enhanced_y = librosa.istft(enhanced_stft)
            
            # –°–æ–∑–¥–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π —Ñ–∞–π–ª
            # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å—Ç—Ä–æ–≥–æ –∫–∞–∫ {stem}_vocals.wav —Ä—è–¥–æ–º —Å –∏—Å—Ö–æ–¥–Ω–∏–∫–æ–º
            p = Path(file_path)
            temp_file = str(p.with_name(f"{p.stem}_vocals.wav"))
            sf.write(temp_file, enhanced_y, sr)
            
            self.logger.debug(f"–£–õ–£–ß–®–ï–ù–ò–ï –ê–£–î–ò–û: –°–æ–∑–¥–∞–Ω —Ñ–∞–π–ª —Å –≤—ã–¥–µ–ª–µ–Ω–Ω—ã–º –≤–æ–∫–∞–ª–æ–º: {temp_file}")
            return temp_file
            
        except ImportError as e:
            self.logger.debug(f"–£–õ–£–ß–®–ï–ù–ò–ï –ê–£–î–ò–û: librosa –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞: {e}")
            return file_path
        except Exception as e:
            self.logger.warning(f"–£–õ–£–ß–®–ï–ù–ò–ï –ê–£–î–ò–û: –û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å librosa: {e}")
            return file_path

    def _cleanup_vocals_file(self, file_path: str) -> None:
        """
        –õ—ë–≥–∫–∞—è –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ –≤–æ–∫–∞–ª–∞ –æ—Ç –æ—Å—Ç–∞—Ç–æ—á–Ω–æ–≥–æ –∞–∫–∫–æ–º–ø–∞–Ω–µ–º–µ–Ω—Ç–∞:
        - –ø–æ–¥–∞–≤–ª–µ–Ω–∏–µ –Ω–∏–∑–∫–∏—Ö —á–∞—Å—Ç–æ—Ç (< 120 –ì—Ü)
        - –º—è–≥–∫–∏–π high-shelf –Ω–∞ –≤–µ—Ä—Ö–∞—Ö, —á—Ç–æ–±—ã —É–±—Ä–∞—Ç—å —à–∏–ø–µ–Ω–∏–µ –æ—Ç –ø–µ—Ä–∫—É—Å—Å–∏–∏
        –ë–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ñ–æ—Ä–º–∞—Ç–∞ —Ñ–∞–π–ª–∞.
        """
        try:
            import librosa
            import soundfile as sf
            import numpy as np
            y, sr = librosa.load(file_path, sr=None, mono=True)
            if y is None or len(y) == 0:
                return
            # –í—ã—Å–æ–∫–æ—á–∞—Å—Ç–æ—Ç–Ω–∞—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è: HPF 2-–≥–æ –ø–æ—Ä—è–¥–∫–∞ ~120 –ì—Ü
            sos = librosa.iirfilter(2, 120.0, rs=None, btype='highpass', ftype='butter', fs=sr, output='sos')
            y = librosa.sosfilt(sos, y)
            # –õ—ë–≥–∫–∏–π high-shelf: –æ—Å–ª–∞–±–∏–º –¥–∏–∞–ø–∞–∑–æ–Ω > 10 –∫–ì—Ü –Ω–∞ -3 –¥–ë —ç–∫–≤–∏–≤–∞–ª–µ–Ω—Ç–Ω–æ (–≥—Ä—É–±–∞—è –∞–ø–ø—Ä–æ–∫—Å–∏–º–∞—Ü–∏—è —á–µ—Ä–µ–∑ EQ –≤ —á–∞—Å—Ç–æ—Ç–Ω–æ–π –æ–±–ª–∞—Å—Ç–∏)
            S = librosa.stft(y)
            freqs = librosa.fft_frequencies(sr=sr)
            shelf = np.ones_like(freqs)
            shelf[freqs >= 10000] = 10 ** (-3/20)
            y = librosa.istft(S * shelf[:, None])
            sf.write(file_path, y, sr)
        except Exception:
            return

    def _refine_vocals_with_background(self, vocals_path: str, temp_dir: Path, model_name: str, track_name: str, bg_weight: float = 0.2) -> None:
        """
        –£–º–µ–Ω—å—à–∞–µ—Ç –æ—Å—Ç–∞—Ç–∫–∏ –∞–∫–∫–æ–º–ø–∞–Ω–µ–º–µ–Ω—Ç–∞ –≤ –≤–æ–∫–∞–ª–µ:
        1) —á–∏—Ç–∞–µ—Ç no_vocals –∏–∑ –≤—Ä–µ–º–µ–Ω–Ω–æ–≥–æ –∫–∞—Ç–∞–ª–æ–≥–∞ Demucs
        2) –¥–µ–ª–∞–µ—Ç –º—è–≥–∫–æ–µ –≤—ã—á–∏—Ç–∞–Ω–∏–µ: vocals = vocals - bg_weight * no_vocals (–ø–æ–¥–≥–æ–Ω –ø–æ –¥–ª–∏–Ω–µ)
        3) –ø—Ä–∏–º–µ–Ω—è–µ—Ç –ª—ë–≥–∫–∏–π EQ (—Ç–æ—Ç –∂–µ, —á—Ç–æ –≤ _cleanup_vocals_file)
        –†–µ–∑—É–ª—å—Ç–∞—Ç –ø–µ—Ä–µ–∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç –≤ vocals_path (–±–µ–∑ —Å–º–µ–Ω—ã —Ñ–æ—Ä–º–∞—Ç–∞/—Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è).
        """
        try:
            import soundfile as sf
            import numpy as np
            import librosa
            # –ü—É—Ç—å –∫ no_vocals
            bg_wav = temp_dir / model_name / track_name / "no_vocals.wav"
            bg_mp3 = temp_dir / model_name / track_name / "no_vocals.mp3"
            bg_file = bg_wav if bg_wav.exists() else (bg_mp3 if bg_mp3.exists() else None)
            if bg_file is None:
                return
            # –ß—Ç–µ–Ω–∏–µ
            y_v, sr = librosa.load(vocals_path, sr=None, mono=True)
            y_bg, sr_bg = librosa.load(str(bg_file), sr=sr, mono=True)
            if len(y_bg) != len(y_v):
                m = min(len(y_bg), len(y_v))
                y_bg = y_bg[:m]
                y_v = y_v[:m]
            # –ú—è–≥–∫–æ–µ –≤—ã—á–∏—Ç–∞–Ω–∏–µ
            y = y_v - float(bg_weight) * y_bg
            # –õ—ë–≥–∫–∞—è –æ—á–∏—Å—Ç–∫–∞ (—Ç–æ—Ç –∂–µ —Ñ–∏–ª—å—Ç—Ä, —á—Ç–æ –≤ _cleanup_vocals_file)
            sos = librosa.iirfilter(2, 120.0, btype='highpass', ftype='butter', fs=sr, output='sos')
            y = librosa.sosfilt(sos, y)
            S = librosa.stft(y)
            freqs = librosa.fft_frequencies(sr=sr)
            shelf = np.ones_like(freqs)
            shelf[freqs >= 10000] = 10 ** (-2/20)
            y = librosa.istft(S * shelf[:, None])
            sf.write(vocals_path, y, sr)
        except Exception:
            return
    
    def list_audio_files(self, folder: str) -> List[Path]:
        """
        –ù–∞—Ö–æ–¥–∏—Ç –≤—Å–µ –∞—É–¥–∏–æ—Ñ–∞–π–ª—ã –≤ —É–∫–∞–∑–∞–Ω–Ω–æ–π –ø–∞–ø–∫–µ.
        
        Args:
            folder: –ü—É—Ç—å –∫ –ø–∞–ø–∫–µ –¥–ª—è –ø–æ–∏—Å–∫–∞
            
        Returns:
            –°–ø–∏—Å–æ–∫ –ø—É—Ç–µ–π –∫ –Ω–∞–π–¥–µ–Ω–Ω—ã–º –∞—É–¥–∏–æ—Ñ–∞–π–ª–∞–º
            
        Raises:
            FileNotFoundError: –ï—Å–ª–∏ –ø–∞–ø–∫–∞ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
        """
        folder_path = Path(folder)
        if not folder_path.exists():
            raise FileNotFoundError(f"–ü–∞–ø–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞: {folder}")
        
        audio_files = []
        for file_path in folder_path.iterdir():
            if not file_path.is_file():
                continue
            if file_path.suffix.lower() not in SUPPORTED_AUDIO_FORMATS:
                continue
            # –ò—Å–∫–ª—é—á–∞–µ–º —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Å—Ç–µ–º—ã –≤–æ–∫–∞–ª–∞ –∏–∑ –ø–µ—Ä–≤–∏—á–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏
            # —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –∑–∞—Ü–∏–∫–ª–∏–≤–∞–Ω–∏—è –ø–∞–π–ø–ª–∞–π–Ω–∞: *_vocals.*
            try:
                if file_path.stem.lower().endswith("_vocals"):
                    continue
            except Exception:
                pass
            audio_files.append(file_path)
        
        return sorted(audio_files)
    
    def choose_file(self, files: List[Path]) -> Optional[Path]:
        """
        –ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–π –≤—ã–±–æ—Ä —Ñ–∞–π–ª–∞ –∏–∑ —Å–ø–∏—Å–∫–∞.
        
        Args:
            files: –°–ø–∏—Å–æ–∫ –ø—É—Ç–µ–π –∫ —Ñ–∞–π–ª–∞–º
            
        Returns:
            –í—ã–±—Ä–∞–Ω–Ω—ã–π —Ñ–∞–π–ª –∏–ª–∏ None –µ—Å–ª–∏ –æ—Ç–º–µ–Ω–µ–Ω–æ
        """
        if not files:
            print("‚ùå –ê—É–¥–∏–æ—Ñ–∞–π–ª—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã")
            return None
        
        print(f"\nüìÅ –ù–∞–π–¥–µ–Ω–Ω—ã–µ –∞—É–¥–∏–æ—Ñ–∞–π–ª—ã:")
        for i, file_path in enumerate(files, 1):
            file_size = file_path.stat().st_size / (1024 * 1024)
            print(f"  {i}. {file_path.name} ({file_size:.1f} –ú–ë)")
        
        print(f"  {len(files) + 1}. ‚ùå –û—Ç–º–µ–Ω–∞")
        
        while True:
            try:
                choice = input(f"\n–í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä —Ñ–∞–π–ª–∞ (1-{len(files)}) –∏–ª–∏ {len(files) + 1} –¥–ª—è –æ—Ç–º–µ–Ω—ã: ")
                choice_num = int(choice)
                
                if choice_num == len(files) + 1:
                    return None
                elif 1 <= choice_num <= len(files):
                    return files[choice_num - 1]
                else:
                    print(f"‚ùå –í–≤–µ–¥–∏—Ç–µ —á–∏—Å–ª–æ –æ—Ç 1 –¥–æ {len(files) + 1}")
            except ValueError:
                print("‚ùå –í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ —á–∏—Å–ª–æ")
            except KeyboardInterrupt:
                return None
    
    def convert_audio_format(self, file_path: Path) -> str:
        """
        –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ—Ç –∞—É–¥–∏–æ—Ñ–∞–π–ª –≤ MP3 —Ñ–æ—Ä–º–∞—Ç –µ—Å–ª–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ.
        
        Args:
            file_path: –ü—É—Ç—å –∫ –∏—Å—Ö–æ–¥–Ω–æ–º—É —Ñ–∞–π–ª—É
            
        Returns:
            –ü—É—Ç—å –∫ –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ–º—É —Ñ–∞–π–ª—É –∏–ª–∏ –∏—Å—Ö–æ–¥–Ω–æ–º—É –µ—Å–ª–∏ –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞
        """
        if AudioSegment is None:
            return str(file_path)
        
        try:
            # –ó–∞–≥—Ä—É–∂–∞–µ–º –∞—É–¥–∏–æ—Ñ–∞–π–ª
            audio = AudioSegment.from_file(str(file_path))
            
            # –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –≤ MP3
            with tempfile.NamedTemporaryFile(suffix='.mp3', delete=False) as temp_file:
                audio.export(temp_file.name, format='mp3')
                return temp_file.name
        except Exception as e:
            print(f"–û—à–∏–±–∫–∞ –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏ –∞—É–¥–∏–æ: {e}")
            return str(file_path)
    
    def _get_transcription_prompt(self) -> str:
        """
        –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π –ø—Ä–æ–º–ø—Ç –¥–ª—è —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏–∏.
        
        Returns:
            –°—Ç—Ä–æ–∫–∞ —Å –ø—Ä–æ–º–ø—Ç–æ–º –¥–ª—è —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏–∏
        """
        return TRANSCRIPTION_PROMPT
    
    def _get_music_transcription_prompt(self) -> str:
        """
        –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –ø—Ä–æ–º–ø—Ç –¥–ª—è —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏–∏ –º—É–∑—ã–∫–∞–ª—å–Ω—ã—Ö –∫–æ–º–ø–æ–∑–∏—Ü–∏–π.
        
        Returns:
            –°—Ç—Ä–æ–∫–∞ —Å –ø—Ä–æ–º–ø—Ç–æ–º –¥–ª—è –º—É–∑—ã–∫–∞–ª—å–Ω–æ–π —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏–∏
        """
        return MUSIC_TRANSCRIPTION_PROMPT
    
    def transcribe_audio(self, file_path: str, debug: bool = False) -> str:
        """
        –†–∞—Å–ø–æ–∑–Ω–∞–µ—Ç —Ä–µ—á—å –≤ –∞—É–¥–∏–æ—Ñ–∞–π–ª–µ —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º –º–Ω–æ–≥–æ—É—Ä–æ–≤–Ω–µ–≤–æ–≥–æ –ø–æ–¥—Ö–æ–¥–∞.
        
        Args:
            file_path: –ü—É—Ç—å –∫ –∞—É–¥–∏–æ—Ñ–∞–π–ª—É
            debug: –í–∫–ª—é—á–∏—Ç—å –æ—Ç–ª–∞–¥–æ—á–Ω—ã–π –≤—ã–≤–æ–¥
            
        Returns:
            –†–∞—Å–ø–æ–∑–Ω–∞–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç
        """
        self.logger.info(f"–¢–†–ê–ù–°–ö–†–ò–ü–¶–ò–Ø: –ù–∞—á–∞–ª–æ –∞–Ω–∞–ª–∏–∑–∞ —Ñ–∞–π–ª–∞: {file_path}")
        try:
            # –£–ª—É—á—à–∞–µ–º –∫–∞—á–µ—Å—Ç–≤–æ –∞—É–¥–∏–æ –¥–ª—è –ª—É—á—à–µ–π —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏–∏
            enhanced_file = self._enhance_audio_for_transcription(file_path)
            
            strict_prompt = self._get_transcription_prompt()
            self.logger.debug(f"–¢–†–ê–ù–°–ö–†–ò–ü–¶–ò–Ø: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω –ø—Ä–æ–º–ø—Ç: {strict_prompt}")
            
            # –ü–æ–ø—ã—Ç–∫–∞ 1: –û—Å–Ω–æ–≤–Ω–æ–π —è–∑—ã–∫ (ru) –Ω–∞ —É–ª—É—á—à–µ–Ω–Ω–æ–º —Ñ–∞–π–ª–µ
            self.logger.debug(f"–¢–†–ê–ù–°–ö–†–ò–ü–¶–ò–Ø: –ü–æ–ø—ã—Ç–∫–∞ 1 - –æ—Å–Ω–æ–≤–Ω–æ–π —è–∑—ã–∫: {self.primary_language}")
            result = self._transcribe_with_language(enhanced_file, self.primary_language, strict_prompt, debug)
            self.logger.debug(f"–¢–†–ê–ù–°–ö–†–ò–ü–¶–ò–Ø: –†–µ–∑—É–ª—å—Ç–∞—Ç 1: '{result}' (–¥–ª–∏–Ω–∞: {len(result)})")

            # –ü–æ–ø—ã—Ç–∫–∞ 2: –ê–≤—Ç–æ-—è–∑—ã–∫ (–µ—Å–ª–∏ –∫–æ—Ä–æ—Ç–∫–æ) ‚Äî —Ç–∞–∫–∂–µ –Ω–∞ —É–ª—É—á—à–µ–Ω–Ω–æ–º —Ñ–∞–π–ª–µ
            if len(result) < MIN_RESULT_LENGTH_FOR_ALT_LANG:
                self.logger.debug("–¢–†–ê–ù–°–ö–†–ò–ü–¶–ò–Ø: –ü–æ–ø—ã—Ç–∫–∞ 2 - –∞–≤—Ç–æ-—è–∑—ã–∫")
                result_auto = self._transcribe_with_language(enhanced_file, None, strict_prompt, debug)
                self.logger.debug(f"–¢–†–ê–ù–°–ö–†–ò–ü–¶–ò–Ø: –†–µ–∑—É–ª—å—Ç–∞—Ç 2: '{result_auto}' (–¥–ª–∏–Ω–∞: {len(result_auto)})")
                if len(result_auto) > len(result):
                    result = result_auto

            # –ü–æ–ø—ã—Ç–∫–∞ 3: –ú—É–∑—ã–∫–∞–ª—å–Ω—ã–π –ø—Ä–æ–º–ø—Ç (–µ—Å–ª–∏ –≤—Å—ë –µ—â—ë –∫–æ—Ä–æ—Ç–∫–æ) ‚Äî —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –ø–æ –∞—É–¥–∏–æ–ø—Ä–∏–∑–Ω–∞–∫–∞–º —ç—Ç–æ –ø–æ—Ö–æ–∂–µ –Ω–∞ –º—É–∑—ã–∫—É
            if len(result) < MIN_RESULT_LENGTH_FOR_MUSIC_PROMPT:
                try:
                    looks_musical = self._is_instrumental_music(file_path)
                except Exception:
                    looks_musical = False
                if looks_musical:
                    self.logger.debug("–¢–†–ê–ù–°–ö–†–ò–ü–¶–ò–Ø: –ü–æ–ø—ã—Ç–∫–∞ 3 - –º—É–∑—ã–∫–∞–ª—å–Ω—ã–π –ø—Ä–æ–º–ø—Ç (–æ–±–Ω–∞—Ä—É–∂–µ–Ω—ã –º—É–∑—ã–∫–∞–ª—å–Ω—ã–µ –ø—Ä–∏–∑–Ω–∞–∫–∏)")
                    music_prompt = self._get_music_transcription_prompt()
                    result_music = self._transcribe_with_language(enhanced_file, None, music_prompt, debug)
                    self.logger.debug(f"–¢–†–ê–ù–°–ö–†–ò–ü–¶–ò–Ø: –†–µ–∑—É–ª—å—Ç–∞—Ç –º—É–∑—ã–∫–∞–ª—å–Ω–æ–≥–æ –ø—Ä–æ–º–ø—Ç–∞: '{result_music}' (–¥–ª–∏–Ω–∞: {len(result_music)})")
                    if len(result_music) > len(result):
                        result = result_music
                    
                    # –ê–Ω–≥–ª–∏–π—Å–∫–∏–π —è–∑—ã–∫ –¥–ª—è –º—É–∑—ã–∫–∞–ª—å–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤ (–µ—Å–ª–∏ –≤—Å—ë –µ—â—ë –∫–æ—Ä–æ—Ç–∫–æ)
                    if len(result) < MIN_RESULT_LENGTH_FOR_MUSIC_PROMPT:
                        self.logger.debug("–¢–†–ê–ù–°–ö–†–ò–ü–¶–ò–Ø: –î–æ–ø. —à–∞–≥ - –∞–Ω–≥–ª–∏–π—Å–∫–∏–π —è–∑—ã–∫ —Å –º—É–∑—ã–∫–∞–ª—å–Ω—ã–º –ø—Ä–æ–º–ø—Ç–æ–º")
                        result_en_music = self._transcribe_with_language(enhanced_file, "en", music_prompt, debug)
                        self.logger.debug(f"–¢–†–ê–ù–°–ö–†–ò–ü–¶–ò–Ø: –†–µ–∑—É–ª—å—Ç–∞—Ç –∞–Ω–≥–ª. –º—É–∑—ã–∫–∞–ª—å–Ω–æ–≥–æ –ø—Ä–æ–º–ø—Ç–∞: '{result_en_music}' (–¥–ª–∏–Ω–∞: {len(result_en_music)})")
                        if len(result_en_music) > len(result):
                            result = result_en_music
                else:
                    self.logger.debug("–¢–†–ê–ù–°–ö–†–ò–ü–¶–ò–Ø: –ú—É–∑—ã–∫–∞–ª—å–Ω—ã–µ –ø—Ä–∏–∑–Ω–∞–∫–∏ –Ω–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω—ã ‚Äî –ø—Ä–æ–ø—É—Å–∫–∞–µ–º –º—É–∑—ã–∫–∞–ª—å–Ω—ã–π –ø—Ä–æ–º–ø—Ç")
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç –Ω–µ —è–≤–ª—è–µ—Ç—Å—è –ø—Ä–æ–º–ø—Ç–æ–º
            result = self._filter_prompt_from_result(result, strict_prompt)
            
            # –ü–æ—Å—Ç-–æ–±—Ä–∞–±–æ—Ç–∫–∞ —Å LLM –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ü–∏–∏ –æ—à–∏–±–æ–∫ (–µ—Å–ª–∏ –≤–∫–ª—é—á–µ–Ω–∞)
            if self.enable_post_process and result and len(result.strip()) > MIN_TEXT_LENGTH_FOR_POST_PROCESS:
                self.logger.debug("–¢–†–ê–ù–°–ö–†–ò–ü–¶–ò–Ø: –ü—Ä–∏–º–µ–Ω—è–µ–º –ø–æ—Å—Ç-–æ–±—Ä–∞–±–æ—Ç–∫—É")
                result = self._post_process_transcription(result, debug)
            
            return result
            
        except Exception as e:
            print(f"–û—à–∏–±–∫–∞ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è —Ä–µ—á–∏: {e}")
            return ""
    
    
    
    def _is_likely_hallucination(self, text: str) -> bool:
        """
        –û–ø—Ä–µ–¥–µ–ª—è–µ—Ç, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —Ç–µ–∫—Å—Ç –≤–µ—Ä–æ—è—Ç–Ω–æ–π –≥–∞–ª–ª—é—Ü–∏–Ω–∞—Ü–∏–µ–π –º–æ–¥–µ–ª–∏.
        –§–∏–ª—å—Ç—Ä—É–µ–º —Ç–æ–ª—å–∫–æ –æ—á–µ–≤–∏–¥–Ω—ã–µ –≥–∞–ª–ª—é—Ü–∏–Ω–∞—Ü–∏–∏, –≤—Å–µ –æ—Å—Ç–∞–ª—å–Ω–æ–µ –¥–æ–≤–µ—Ä—è–µ–º –ò–ò.
        
        Args:
            text: –¢–µ–∫—Å—Ç –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞
            
        Returns:
            True –µ—Å–ª–∏ —Ç–µ–∫—Å—Ç –ø–æ—Ö–æ–∂ –Ω–∞ –æ—á–µ–≤–∏–¥–Ω—É—é –≥–∞–ª–ª—é—Ü–∏–Ω–∞—Ü–∏—é
        """
        if not text or len(text) < 3:
            return False
        
        import re
        
        # 1. –û—á–µ–≤–∏–¥–Ω—ã–µ –≥–∞–ª–ª—é—Ü–∏–Ω–∞—Ü–∏–∏ - –æ—á–µ–Ω—å –∫–æ—Ä–æ—Ç–∫–∏–µ —Ç–µ–∫—Å—Ç—ã —Å —Å–∏–º–≤–æ–ª–∞–º–∏
        if len(text) <= 5 and re.match(r'^[.!?,#\-_]+$', text):
            self.logger.debug(f"–ì–ê–õ–õ–Æ–¶–ò–ù–ê–¶–ò–Ø: —Ç–µ–∫—Å—Ç '{text}' –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω - —Ç–æ–ª—å–∫–æ —Å–∏–º–≤–æ–ª—ã")
            return True
        
        # 2. –¢–µ–∫—Å—Ç—ã —Å–æ—Å—Ç–æ—è—â–∏–µ —Ç–æ–ª—å–∫–æ –∏–∑ —Å–∏–º–≤–æ–ª–æ–≤ (–±–µ–∑ –±—É–∫–≤)
        if re.match(r'^[^–∞-—è—ëa-z\s]+$', text):
            self.logger.debug(f"–ì–ê–õ–õ–Æ–¶–ò–ù–ê–¶–ò–Ø: —Ç–µ–∫—Å—Ç '{text}' –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω - —Ç–æ–ª—å–∫–æ —Å–∏–º–≤–æ–ª—ã")
            return True
        
        # 3. –¢–µ–∫—Å—Ç—ã –≤ –∫–≤–∞–¥—Ä–∞—Ç–Ω—ã—Ö —Å–∫–æ–±–∫–∞—Ö (–æ–ø–∏—Å–∞–Ω–∏—è –∑–≤—É–∫–æ–≤)
        if text.startswith('[') and text.endswith(']'):
            self.logger.debug(f"–ì–ê–õ–õ–Æ–¶–ò–ù–ê–¶–ò–Ø: —Ç–µ–∫—Å—Ç '{text}' –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω - –æ–ø–∏—Å–∞–Ω–∏–µ –∑–≤—É–∫–∞")
            return True
        
        # 4. –¢–µ–∫—Å—Ç—ã —Å –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–º–∏ —Å–∏–º–≤–æ–ª–∞–º–∏ –ø–æ–¥—Ä—è–¥ (4+ –æ–¥–∏–Ω–∞–∫–æ–≤—ã—Ö —Å–∏–º–≤–æ–ª–∞)
        if re.search(r'(.)\1{3,}', text):  # 4+ –æ–¥–∏–Ω–∞–∫–æ–≤—ã—Ö —Å–∏–º–≤–æ–ª–∞ –ø–æ–¥—Ä—è–¥
            self.logger.debug(f"–ì–ê–õ–õ–Æ–¶–ò–ù–ê–¶–ò–Ø: —Ç–µ–∫—Å—Ç '{text}' –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω - –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ —Å–∏–º–≤–æ–ª—ã")
            return True
        
        # 5. –î–µ—Ç—Å–∫–∏–π –ø–ª–∞—á - –ø–æ–≤—Ç–æ—Ä—è—é—â–∏–µ—Å—è –≥–ª–∞—Å–Ω—ã–µ (5+ –ø–æ–¥—Ä—è–¥)
        if re.search(r'[–∞–æ—É—ç—ã–∏–µ—ë—é—è]{5,}', text.lower()):
            self.logger.debug(f"–ì–ê–õ–õ–Æ–¶–ò–ù–ê–¶–ò–Ø: —Ç–µ–∫—Å—Ç '{text}' –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω - –¥–µ—Ç—Å–∫–∏–π –ø–ª–∞—á")
            return True
        
        # 6. –û—á–µ–Ω—å –∫–æ—Ä–æ—Ç–∫–∏–µ —Ç–µ–∫—Å—Ç—ã (–¥–æ 3 —Å–∏–º–≤–æ–ª–æ–≤) —Å –ø–æ–≤—Ç–æ—Ä—è—é—â–∏–º–∏—Å—è —Å–ª–æ–≤–∞–º–∏
        words = text.split()
        if len(text) <= 3 and len(words) <= 1 and len(set(words)) < len(words):
            self.logger.debug(f"–ì–ê–õ–õ–Æ–¶–ò–ù–ê–¶–ò–Ø: —Ç–µ–∫—Å—Ç '{text}' –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω - –æ—á–µ–Ω—å –∫–æ—Ä–æ—Ç–∫–∏–µ –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏—è")
            return True
        
        # –í—Å–µ –æ—Å—Ç–∞–ª—å–Ω–æ–µ –¥–æ–≤–µ—Ä—è–µ–º –ò–ò –¥–ª—è –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏–∏
        return False
    
    def _filter_prompt_from_result(self, result: str, prompt: str) -> str:
        """
        –§–∏–ª—å—Ç—Ä—É–µ—Ç –ø—Ä–æ–º–ø—Ç –∏–∑ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏–∏ –∏ –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç –≥–∞–ª–ª—é—Ü–∏–Ω–∞—Ü–∏–∏.
        –í–∫–ª—é—á–∞–µ—Ç –¥–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏.
        
        Args:
            result: –†–µ–∑—É–ª—å—Ç–∞—Ç —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏–∏
            prompt: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–Ω—ã–π –ø—Ä–æ–º–ø—Ç
            
        Returns:
            –û—á–∏—â–µ–Ω–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç
        """
        self.logger.debug(f"–§–ò–õ–¨–¢–†–ê–¶–ò–Ø: –í—Ö–æ–¥–Ω–æ–π —Ç–µ–∫—Å—Ç: '{result}'")
        self.logger.debug(f"–§–ò–õ–¨–¢–†–ê–¶–ò–Ø: –ü—Ä–æ–º–ø—Ç: '{prompt}'")
        
        if not result or not prompt:
            self.logger.debug("–§–ò–õ–¨–¢–†–ê–¶–ò–Ø: –ü—É—Å—Ç–æ–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç –∏–ª–∏ –ø—Ä–æ–º–ø—Ç")
            return result
        
        result_lower = result.lower().strip()
        prompt_lower = prompt.lower().strip()
        
        # 1. –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å–æ–¥–µ—Ä–∂–∏—Ç –ª–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç –ø—Ä–æ–º–ø—Ç (—Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç –æ—á–µ–Ω—å –ø–æ—Ö–æ–∂ –Ω–∞ –ø—Ä–æ–º–ø—Ç)
        if result_lower == prompt_lower:
            self.logger.warning(f"–§–ò–õ–¨–¢–†–ê–¶–ò–Ø: –†–µ–∑—É–ª—å—Ç–∞—Ç –∏–¥–µ–Ω—Ç–∏—á–µ–Ω –ø—Ä–æ–º–ø—Ç—É - –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–æ")
            return ""
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å–æ–¥–µ—Ä–∂–∏—Ç –ª–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç –±–æ–ª—å—à—É—é —á–∞—Å—Ç—å –ø—Ä–æ–º–ø—Ç–∞
        if len(result_lower) > 100 and len(prompt_lower) / len(result_lower) > 0.5:
            # –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞: –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ –ª–∏ —ç—Ç–æ –ø—Ä–æ–º–ø—Ç?
            if prompt_lower[:50] in result_lower or result_lower[:50] in prompt_lower:
                self.logger.warning(f"–§–ò–õ–¨–¢–†–ê–¶–ò–Ø: –†–µ–∑—É–ª—å—Ç–∞—Ç —Å–æ–¥–µ—Ä–∂–∏—Ç –±–æ–ª—å—à—É—é —á–∞—Å—Ç—å –ø—Ä–æ–º–ø—Ç–∞ - –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–æ")
                return ""
        
        # 2. –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞ —á–∞—Å—Ç–∏—á–Ω–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ —Å –∫–ª—é—á–µ–≤—ã–º–∏ —Ñ—Ä–∞–∑–∞–º–∏ –ø—Ä–æ–º–ø—Ç–∞
        prompt_keywords = [
            "–¥–æ—Å–ª–æ–≤–Ω—É—é", "–ø–æ–ª–Ω—É—é", "—Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏—é", "–±–µ–∑ –ø–µ—Ä–µ–≤–æ–¥–∞", 
            "—Å–æ—Ö—Ä–∞–Ω—è–π —è–∑—ã–∫", "–Ω–µ –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∏—Ä—É–π", "–Ω–µ —Å–æ–∫—Ä–∞—â–∞–π", "–Ω–µ –∏—Å–ø—Ä–∞–≤–ª—è–π"
        ]
        
        keyword_matches = sum(1 for keyword in prompt_keywords if keyword in result_lower)
        if keyword_matches > len(prompt_keywords) // 2:
            self.logger.warning(f"–§–ò–õ–¨–¢–†–ê–¶–ò–Ø: –ù–∞–π–¥–µ–Ω–æ {keyword_matches} –∫–ª—é—á–µ–≤—ã—Ö —Å–ª–æ–≤ –ø—Ä–æ–º–ø—Ç–∞ - –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–æ")
            return ""
        
        # 3. –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞ –≥–∞–ª–ª—é—Ü–∏–Ω–∞—Ü–∏–∏ - –ø–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω—ã–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã
        if self._is_likely_hallucination(result_lower):
            self.logger.warning(f"–§–ò–õ–¨–¢–†–ê–¶–ò–Ø: –¢–µ–∫—Å—Ç –æ–ø—Ä–µ–¥–µ–ª–µ–Ω –∫–∞–∫ –≥–∞–ª–ª—é—Ü–∏–Ω–∞—Ü–∏—è - –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–æ")
            return ""
        
        self.logger.debug(f"–§–ò–õ–¨–¢–†–ê–¶–ò–Ø: –¢–µ–∫—Å—Ç –ø—Ä–æ—à–µ–ª —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—é: '{result}'")
        return result
    
    def _transcribe_with_language(self, file_path: str, language: Optional[str], prompt: str, debug: bool) -> str:
        """
        –í—ã–ø–æ–ª–Ω—è–µ—Ç —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏—é —Å —É–∫–∞–∑–∞–Ω–Ω—ã–º —è–∑—ã–∫–æ–º –∏ –ø—Ä–æ–º–ø—Ç–æ–º.
        
        Args:
            file_path: –ü—É—Ç—å –∫ –∞—É–¥–∏–æ—Ñ–∞–π–ª—É
            language: –Ø–∑—ã–∫ –¥–ª—è —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è (None –¥–ª—è –∞–≤—Ç–æ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è)
            prompt: –ü—Ä–æ–º–ø—Ç –¥–ª—è —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏–∏
            debug: –í–∫–ª—é—á–∏—Ç—å –æ—Ç–ª–∞–¥–æ—á–Ω—ã–π –≤—ã–≤–æ–¥
            
        Returns:
            –†–∞—Å–ø–æ–∑–Ω–∞–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç
        """
        try:
            with open(file_path, 'rb') as audio_file:
                params = {
                    "model": "gpt-4o-transcribe",
                    "file": audio_file,
                    "response_format": "text",
                    "prompt": prompt
                }
                if language:
                    params["language"] = language
                
                transcript = openai.audio.transcriptions.create(**params)
            
            result = transcript.strip()
            if debug:
                lang_label = language or "–∞–≤—Ç–æ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ"
                # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≤ –æ—Ç–ª–∞–¥–∫–µ
                filtered_result = self._filter_prompt_from_result(result, prompt)
                if filtered_result != result:
                    print(f"üìù –° —è–∑—ã–∫–æ–º ({lang_label}): '{result}' ‚Üí –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–æ ‚Üí '{filtered_result}'")
                else:
                    print(f"üìù –° —è–∑—ã–∫–æ–º ({lang_label}): '{result}'")
            
            return result
            
        except Exception as e:
            # –£–ª—É—á—à–∏–º —á–∏—Ç–∞–µ–º–æ—Å—Ç—å —Ç–∏–ø–∏—á–Ω—ã—Ö —Å–µ—Ç–µ–≤—ã—Ö/—Ä–µ–≥–∏–æ–Ω–∞–ª—å–Ω—ã—Ö –æ—à–∏–±–æ–∫
            error_text = str(e)
            if "unsupported_country_region_territory" in error_text or "403" in error_text:
                if debug and not self._region_error_notified:
                    print("‚ùå –î–æ—Å—Ç—É–ø –∫ API –æ–≥—Ä–∞–Ω–∏—á–µ–Ω –ø–æ —Ä–µ–≥–∏–æ–Ω—É (403). –ü—Ä–æ–≤–µ—Ä—å—Ç–µ VPN/–ø—Ä–æ–∫—Å–∏ –∏–ª–∏ —Ä–µ–≥–∏–æ–Ω –∞–∫–∫–∞—É–Ω—Ç–∞ OpenAI.")
                    self._region_error_notified = True
            if debug:
                lang_label = language or "–∞–≤—Ç–æ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ"
                print(f"‚ùå –û—à–∏–±–∫–∞ —Å —è–∑—ã–∫–æ–º ({lang_label}): {e}")
            return ""
    
    def classify_audio(self, file_path: str, transcript_text: Optional[str] = None) -> str:
        """
        –ö–ª–∞—Å—Å–∏—Ñ–∏—Ü–∏—Ä—É–µ—Ç –∞—É–¥–∏–æ—Ñ–∞–π–ª —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º –ò–ò –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏–∏.
        
        Args:
            file_path: –ü—É—Ç—å –∫ –∞—É–¥–∏–æ—Ñ–∞–π–ª—É
            transcript_text: –£–∂–µ –ø–æ–ª—É—á–µ–Ω–Ω–∞—è —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏—è –¥–ª—è —ç—Ç–æ–≥–æ —Ñ–∞–π–ª–∞ (–µ—Å–ª–∏ –µ—Å—Ç—å)
            
        Returns:
            –ö–∞—Ç–µ–≥–æ—Ä–∏—è –∞—É–¥–∏–æ: '–º—É–∑—ã–∫–∞', '—Ä–µ—á—å' –∏–ª–∏ '—à—É–º'
        """
        try:
            # –ï—Å–ª–∏ —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏—è —É–∂–µ –ø–æ–ª—É—á–µ–Ω–∞ –Ω–∞ –ø—Ä–µ–¥—ã–¥—É—â–µ–º —ç—Ç–∞–ø–µ ‚Äî –∏—Å–ø–æ–ª—å–∑—É–µ–º –µ—ë –Ω–∞–ø—Ä—è–º—É—é,
            # —á—Ç–æ–±—ã –Ω–µ –≤—ã–ø–æ–ª–Ω—è—Ç—å –ø–æ–≤—Ç–æ—Ä–Ω—É—é —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏—é –∏ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–Ω–æ—Å—Ç—å.
            if transcript_text is None:
                strict_prompt = self._get_transcription_prompt()
                transcript_text = self._transcribe_with_language(file_path, self.primary_language, strict_prompt, False)
                transcript_text = self._filter_prompt_from_result(transcript_text, strict_prompt)

            # –≠–≤—Ä–∏—Å—Ç–∏–∫–∞: —è–≤–Ω—ã–π —à—É–º –ø–æ —Ç–µ–∫—Å—Ç—É ‚Üí —à—É–º (–ø–µ—Ä–µ–∫—Ä—ã–≤–∞–µ—Ç –≤–æ–∫–∞–ª–∏–∑–∞—Ü–∏–∏)
            if transcript_text and self._looks_like_noise(transcript_text):
                return "—à—É–º"

            # –≠–≤—Ä–∏—Å—Ç–∏–∫–∞: –∫–æ—Ä–æ—Ç–∫–∏–µ –≤–æ–∫–∞–ª–∏–∑–∞—Ü–∏–∏ (¬´la¬ª, ¬´na¬ª, ¬´ah¬ª, ¬´–æ-–æ-–æ¬ª) ‚Üí –º—É–∑—ã–∫–∞
            if transcript_text and self._looks_like_vocalizations(transcript_text):
                return "–º—É–∑—ã–∫–∞"
            
            if not transcript_text:
                # –ü—É—Å—Ç–∞—è —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏—è: –ø—Ä–æ–≤–µ—Ä–∏–º –ø—Ä–æ—Å—Ç—ã–µ –∞—É–¥–∏–æ–ø—Ä–∏–∑–Ω–∞–∫–∏ (—Ä–∏—Ç–º/—Ç–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å) –¥–ª—è –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞–ª—å–Ω–æ–π –º—É–∑—ã–∫–∏
                if self._is_instrumental_music(file_path):
                    return "–º—É–∑—ã–∫–∞"
                return "—à—É–º"
            
            # –ò—Å–ø–æ–ª—å–∑—É–µ–º –ò–ò –¥–ª—è –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏–∏
            classification_result = self._classify_with_ai(transcript_text)

            # –ï—Å–ª–∏ –ò–ò –¥–∞–ª "—à—É–º", –Ω–æ –ø–æ –ø—Ä–∏–∑–Ω–∞–∫–∞–º —Ñ–∞–π–ª –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞–ª—å–Ω–∞—è –º—É–∑—ã–∫–∞ ‚Äî –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä—É–µ–º –Ω–∞ "–º—É–∑—ã–∫–∞"
            if classification_result == "—à—É–º":
                try:
                    if self._is_instrumental_music(file_path):
                        return "–º—É–∑—ã–∫–∞"
                except Exception:
                    pass
            
            return classification_result
            
        except Exception as e:
            print(f"–û—à–∏–±–∫–∞ –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏–∏ –∞—É–¥–∏–æ: {e}")
            return "—à—É–º"

    def _looks_like_vocalizations(self, text: str) -> bool:
        """
        –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç True, –µ—Å–ª–∏ —Ç–µ–∫—Å—Ç –ø–æ—Ö–æ–∂ –Ω–∞ –≤–æ–∫–∞–ª–∏–∑–∞—Ü–∏–∏/–º–µ–∂–¥–æ–º–µ—Ç–∏—è –±–µ–∑ —Å–≤—è–∑–Ω–æ–π —Ä–µ—á–∏
        (la-la, na-na, ah, oh, ooo –∏ —Ç.–ø.), —Ö–∞—Ä–∞–∫—Ç–µ—Ä–Ω—ã–µ –¥–ª—è –º—É–∑—ã–∫–∏.
        """
        if not text:
            return False
        import re
        t = text.lower()
        # –ù–∞–ª–∏—á–∏–µ –ø–æ–≤—Ç–æ—Ä—è—é—â–∏—Ö—Å—è –≤–æ–∫–∞–ª—å–Ω—ã—Ö —Å–ª–æ–≥–æ–≤
        patterns = [r"\b(la)+\b", r"\b(na)+\b", r"\b(da)+\b", r"\b(ba)+\b",
                    r"\b(ah|aah|aaa)+\b", r"\b(oh|ooh|ooo)+\b", r"\b(yeah|yea)+\b"]
        if any(re.search(p, t) for p in patterns):
            return True
        # –ö–æ—Ä–æ—Ç–∫–∏–π —Ç–µ–∫—Å—Ç —Å –ø–æ–≤—Ç–æ—Ä—è—é—â–∏–º–∏—Å—è —Å–ª–æ–≥–∞–º–∏/–º–µ–∂–¥–æ–º–µ—Ç–∏—è–º–∏
        words = re.findall(r"[a-z–∞-—è—ë]+", t)
        if len(" ".join(words)) <= 40 and len(set(words)) <= max(1, len(words)//2):
            return True
        return False

    def _looks_like_noise(self, text: str) -> bool:
        """
        –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç True, –µ—Å–ª–∏ —Ç–µ–∫—Å—Ç –ø–æ—Ö–æ–∂ –Ω–∞ —à—É–º/–Ω–µ—Ä–µ—á–µ–≤—ã–µ –∑–≤—É–∫–∏ (–Ω–∞–ø—Ä. "—à—à—à", "—â—â—â", "--").
        –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è —è–≤–Ω–æ–≥–æ –æ—Ç–Ω–µ—Å–µ–Ω–∏—è –∫ —à—É–º—É –¥–æ –æ–±—Ä–∞—â–µ–Ω–∏—è –∫ –ò–ò.
        """
        if not text:
            return False
        import re
        t = text.strip().lower()
        # –û—á–µ–Ω—å –∫–æ—Ä–æ—Ç–∫–∞—è —Å—Ç—Ä–æ–∫–∞ –±–µ–∑ –ø—Ä–æ–±–µ–ª–æ–≤ –∏ –ø—É–Ω–∫—Ç—É–∞—Ü–∏–∏ ‚Üí —à—É–º
        if len(t) <= 3 and ' ' not in t and re.fullmatch(r"[\W_\-‚Äì‚Äî~]+|[a-z–∞-—è—ë]+", t):
            # –ï—Å–ª–∏ —ç—Ç–æ –Ω–µ —è–≤–Ω–∞—è –≤–æ–∫–∞–ª–∏–∑–∞—Ü–∏—è
            if not self._looks_like_vocalizations(t):
                return True
        # –ü–æ–≤—Ç–æ—Ä—è—é—â–∏–µ—Å—è —Å–æ–≥–ª–∞—Å–Ω—ã–µ, —Ö–∞—Ä–∞–∫—Ç–µ—Ä–Ω—ã–µ –¥–ª—è "—à—É–º–æ–≤" (—à/—â/—Å/–∑/h)
        if re.fullmatch(r"[—à—â—Å–∑h]+", t) and len(t) <= 10:
            return True
        # –ü–æ—á—Ç–∏ –Ω–µ—Ç —Å–ª–æ–≤: 1 –∫–æ—Ä–æ—Ç–∫–æ–µ "—Å–ª–æ–≤–æ" –¥–æ 3-4 —Å–∏–º–≤–æ–ª–æ–≤
        words = re.findall(r"[a-z–∞-—è—ë]+", t)
        if len(words) <= 1 and (len(t) <= 4 or (words and len(words[0]) <= 3)):
            if not self._looks_like_vocalizations(t):
                return True
        return False

    def _is_instrumental_music(self, file_path: str) -> bool:
        """
        –ì—Ä—É–±–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞–ª—å–Ω—É—é –º—É–∑—ã–∫—É –ø–æ –∞—É–¥–∏–æ–ø—Ä–∏–∑–Ω–∞–∫–∞–º, –µ—Å–ª–∏ —Ä–µ—á–∏ –Ω–µ—Ç.
        –ò—Å–ø–æ–ª—å–∑—É–µ—Ç librosa: HPSS (–≥–∞—Ä–º–æ–Ω–∏—á–µ—Å–∫–∞—è —Å–æ—Å—Ç–∞–≤–ª—è—é—â–∞—è), —Ç–µ–º–ø/—Ä–∏—Ç–º, —Å–ø–µ–∫—Ç—Ä–∞–ª—å–Ω–∞—è –ø–ª–æ—Å–∫–æ—Å—Ç–Ω–æ—Å—Ç—å,
        —Ö—Ä–æ–º–∞ (–≥–∞—Ä–º–æ–Ω–∏—á–Ω–æ—Å—Ç—å) –∏ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –æ–Ω—Å–µ—Ç–æ–≤. –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç True –ø—Ä–∏ –ø—Ä–µ–æ–±–ª–∞–¥–∞–Ω–∏–∏ –º—É–∑—ã–∫–∞–ª—å–Ω—ã—Ö –ø—Ä–∏–∑–Ω–∞–∫–æ–≤.
        """
        try:
            import librosa
            import numpy as np
            y, sr = librosa.load(file_path, sr=None, mono=True)
            if y is None or len(y) == 0:
                return False

            # HPSS: –¥–æ–ª—è –≥–∞—Ä–º–æ–Ω–∏—á–µ—Å–∫–æ–π —ç–Ω–µ—Ä–≥–∏–∏
            H, P = librosa.effects.hpss(librosa.stft(y))
            harm_energy = float(np.sum(np.abs(H)))
            perc_energy = float(np.sum(np.abs(P)))
            total_energy = harm_energy + perc_energy + 1e-9
            harmonic_ratio = harm_energy / total_energy

            # –û–Ω—Å–µ—Ç-—ç–Ω–µ—Ä–≥–∏—è –∏ —Ç–µ–º–ø
            onset_env = librosa.onset.onset_strength(y=y, sr=sr)
            tempo, _ = librosa.beat.beat_track(onset_envelope=onset_env, sr=sr)
            onset_mean = float(np.mean(onset_env))

            # –ï—Å–ª–∏ —Ç–µ–º–ø –Ω–µ –æ–ø—Ä–µ–¥–µ–ª–∏–ª—Å—è, –æ—Ü–µ–Ω–∏–º —Ä–∏—Ç–º–∏—á–Ω–æ—Å—Ç—å –ø–æ –∞–≤—Ç–æ–∫–æ—Ä—Ä–µ–ª—è—Ü–∏–∏ –æ–Ω—Å–µ—Ç–æ–≤
            def has_periodic_onsets(env: np.ndarray) -> bool:
                if env.size < 64:
                    return False
                env = (env - env.mean()) / (env.std() + 1e-9)
                corr = np.correlate(env, env, mode='full')[env.size-1:]
                corr[0] = 0.0
                peak = float(np.max(corr[: min(len(corr), 512)]))
                return peak > 20.0

            # –°–ø–µ–∫—Ç—Ä–∞–ª—å–Ω–∞—è –ø–ª–æ—Å–∫–æ—Å—Ç–Ω–æ—Å—Ç—å (–º—É–∑—ã–∫–∞ –æ–±—ã—á–Ω–æ –º–µ–Ω–µ–µ ¬´–ø–ª–æ—Å–∫–∞—è¬ª, —á–µ–º —à—É–º)
            S_mag, _ = librosa.magphase(librosa.stft(y))
            flatness = float(np.mean(librosa.feature.spectral_flatness(S=S_mag)))

            # –•—Ä–æ–º–∞: —Å—Ç–∞–±–∏–ª—å–Ω–æ –≤—ã—Ä–∞–∂–µ–Ω–Ω–∞—è –≥–∞—Ä–º–æ–Ω–∏—á–Ω–æ—Å—Ç—å (–≤–∞—Ä–∏–∞—Ç–∏–≤–Ω–æ—Å—Ç—å –∏ —ç–Ω–µ—Ä–≥–∏—è)
            chroma = librosa.feature.chroma_stft(S=S_mag, sr=sr)
            chroma_energy = float(np.mean(chroma))
            chroma_var = float(np.mean(np.var(chroma, axis=1)))

            # –ü—Ä–∏–∑–Ω–∞–∫–∏ (–ø–æ—Ä–æ–≥–∏ –µ—â—ë –±–æ–ª–µ–µ –º—è–≥–∫–∏–µ –¥–ª—è —ç–ª–µ–∫—Ç—Ä–æ–Ω–Ω–æ–π/–ø–æ–ø –º—É–∑—ã–∫–∏)
            rhythmic = (tempo >= 30.0) or has_periodic_onsets(onset_env)
            harmonic = (harmonic_ratio >= 0.20) or (chroma_energy >= 0.10 and chroma_var >= 0.002)
            non_flat = flatness < 0.70
            onset_active = onset_mean > 0.06

            score = sum([rhythmic, harmonic, non_flat, onset_active])
            return score >= 2
        except Exception:
            return False
    
    def _classify_with_ai(self, transcript_text: str) -> str:
        """
        –ö–ª–∞—Å—Å–∏—Ñ–∏—Ü–∏—Ä—É–µ—Ç –∞—É–¥–∏–æ —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º –ò–ò –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏–∏.
        
        Args:
            transcript_text: –†–∞—Å–ø–æ–∑–Ω–∞–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç
            
        Returns:
            –ö–∞—Ç–µ–≥–æ—Ä–∏—è –∞—É–¥–∏–æ: '–º—É–∑—ã–∫–∞', '—Ä–µ—á—å' –∏–ª–∏ '—à—É–º'
        """
        try:
            system_prompt = CLASSIFICATION_PROMPT

            response = openai.chat.completions.create(
                model=LLM_MODEL,
                messages=[
                    {"role": "system", "content": system_prompt},
                    {"role": "user", "content": f"–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π —Å–ª–µ–¥—É—é—â–∏–π —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ç –∞—É–¥–∏–æ –∏ –∫–ª–∞—Å—Å–∏—Ñ–∏—Ü–∏—Ä—É–π –µ–≥–æ:\n\n{transcript_text}"}
                ],
                temperature=CLASSIFICATION_TEMPERATURE,
                max_tokens=CLASSIFICATION_MAX_TOKENS
            )
            
            result_text = response.choices[0].message.content.strip()
            
            # –ü–∞—Ä—Å–∏–º JSON –æ—Ç–≤–µ—Ç
            import json
            try:
                result = json.loads(result_text)
                classification = result.get("classification", "noise")
                
                # –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –∞–Ω–≥–ª–∏–π—Å–∫–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –≤ —Ä—É—Å—Å–∫–∏–µ
                if classification == "music":
                    return "–º—É–∑—ã–∫–∞"
                elif classification == "speech":
                    return "—Ä–µ—á—å"
                else:
                    return "—à—É–º"
                    
            except json.JSONDecodeError:
                # –ï—Å–ª–∏ JSON –Ω–µ –ø–∞—Ä—Å–∏—Ç—Å—è, –ø–æ–ø—Ä–æ–±—É–µ–º –∏–∑–≤–ª–µ—á—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é –∏–∑ —Ç–µ–∫—Å—Ç–∞
                result_lower = result_text.lower()
                if "music" in result_lower or "–º—É–∑—ã–∫–∞" in result_lower:
                    return "–º—É–∑—ã–∫–∞"
                elif "speech" in result_lower or "—Ä–µ—á—å" in result_lower:
                    return "—Ä–µ—á—å"
                else:
                    return "—à—É–º"
                    
        except Exception as e:
            print(f"–û—à–∏–±–∫–∞ –ò–ò-–∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏–∏: {e}")
            return "—à—É–º"
    
    def analyze_audio(self, file_path: Path, debug: bool = False) -> Dict[str, Union[str, float, datetime]]:
        """
        –í—ã–ø–æ–ª–Ω—è–µ—Ç –ø–æ–ª–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –∞—É–¥–∏–æ—Ñ–∞–π–ª–∞.
        
        Args:
            file_path: –ü—É—Ç—å –∫ –∞—É–¥–∏–æ—Ñ–∞–π–ª—É
            debug: –í–∫–ª—é—á–∏—Ç—å –æ—Ç–ª–∞–¥–æ—á–Ω—ã–π –≤—ã–≤–æ–¥
            
        Returns:
            –°–ª–æ–≤–∞—Ä—å —Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º–∏ –∞–Ω–∞–ª–∏–∑–∞
        """
        print(f"\nüîç –ê–Ω–∞–ª–∏–∑–∏—Ä—É—é —Ñ–∞–π–ª: {file_path.name}")
        
        # –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º —Ñ–æ—Ä–º–∞—Ç –µ—Å–ª–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ
        converted_path = self.convert_audio_format(file_path)
        
        if debug:
            print(f"üìÅ –ü–æ–ª–Ω—ã–π –ø—É—Ç—å: {file_path.absolute()}")
            print(f"üìä –†–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞: {file_path.stat().st_size / (1024 * 1024):.2f} –ú–ë")
        
        # –†–∞—Å–ø–æ–∑–Ω–∞–µ–º —Ä–µ—á—å
        print("üìù –†–∞—Å–ø–æ–∑–Ω–∞—é —Ä–µ—á—å...")
        transcript = self.transcribe_audio(converted_path, debug)
        
        # –ö–ª–∞—Å—Å–∏—Ñ–∏—Ü–∏—Ä—É–µ–º –∞—É–¥–∏–æ (–ø–µ—Ä–µ–¥–∞–µ–º —É–∂–µ –ø–æ–ª—É—á–µ–Ω–Ω—É—é —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏—é, —á—Ç–æ–±—ã –Ω–µ –∑–∞–ø—É—Å–∫–∞—Ç—å STT –ø–æ–≤—Ç–æ—Ä–Ω–æ)
        print("üè∑Ô∏è –ö–ª–∞—Å—Å–∏—Ñ–∏—Ü–∏—Ä—É—é –∞—É–¥–∏–æ...")
        audio_type = self.classify_audio(converted_path, transcript_text=transcript)
        
        if debug:
            print(f"üè∑Ô∏è –†–µ–∑—É–ª—å—Ç–∞—Ç –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏–∏: {audio_type}")
        
        # –û—á–∏—â–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π —Ñ–∞–π–ª –µ—Å–ª–∏ –æ–Ω –±—ã–ª —Å–æ–∑–¥–∞–Ω
        if converted_path != str(file_path) and os.path.exists(converted_path):
            try:
                os.unlink(converted_path)
            except OSError:
                pass  # –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ—à–∏–±–∫–∏ —É–¥–∞–ª–µ–Ω–∏—è –≤—Ä–µ–º–µ–Ω–Ω–æ–≥–æ —Ñ–∞–π–ª–∞
        
        return {
            'file_name': file_path.name,
            'file_path': str(file_path.absolute()),
            'file_size_mb': file_path.stat().st_size / (1024 * 1024),
            'audio_type': audio_type,
            'transcript': transcript,
            'analysis_time': datetime.now()
        }
    
    def analyze_all_files(self, folder: str, debug: bool = False) -> List[Dict[str, Union[str, float, datetime]]]:
        """
        –í—ã–ø–æ–ª–Ω—è–µ—Ç –ø–∞–∫–µ—Ç–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –≤—Å–µ—Ö –∞—É–¥–∏–æ—Ñ–∞–π–ª–æ–≤ –≤ –ø–∞–ø–∫–µ.
        
        Args:
            folder: –ü—É—Ç—å –∫ –ø–∞–ø–∫–µ —Å –∞—É–¥–∏–æ—Ñ–∞–π–ª–∞–º–∏
            debug: –í–∫–ª—é—á–∏—Ç—å –æ—Ç–ª–∞–¥–æ—á–Ω—ã–π –≤—ã–≤–æ–¥
            
        Returns:
            –°–ø–∏—Å–æ–∫ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –∞–Ω–∞–ª–∏–∑–∞
        """
        print(f"üîç –ü–∞–∫–µ—Ç–Ω—ã–π –∞–Ω–∞–ª–∏–∑ —Ñ–∞–π–ª–æ–≤ –≤ –ø–∞–ø–∫–µ: {folder}")
        
        try:
            files = self.list_audio_files(folder)
            print(f"‚úÖ –ù–∞–π–¥–µ–Ω–æ {len(files)} –∞—É–¥–∏–æ—Ñ–∞–π–ª–æ–≤")
            
            results = []
            for i, file_path in enumerate(files, 1):
                print(f"\nüìÅ –û–±—Ä–∞–±–∞—Ç—ã–≤–∞—é —Ñ–∞–π–ª {i}/{len(files)}: {file_path.name}")
                
                result = self.analyze_audio(file_path, debug)
                results.append(result)
                
                print(f"‚úÖ –ó–∞–≤–µ—Ä—à–µ–Ω–æ: {result['audio_type']}")
            
            return results
            
        except Exception as e:
            print(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–∞–∫–µ—Ç–Ω–æ–º –∞–Ω–∞–ª–∏–∑–µ: {e}")
            return []
    
    def save_results(self, results: List[Dict[str, Union[str, float, datetime]]], filename: Optional[str] = None, single_file: bool = False) -> str:
        """
        –°–æ—Ö—Ä–∞–Ω—è–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –∞–Ω–∞–ª–∏–∑–∞ –≤ —Ñ–∞–π–ª.
        
        Args:
            results: –°–ø–∏—Å–æ–∫ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –∞–Ω–∞–ª–∏–∑–∞
            filename: –ò–º—è —Ñ–∞–π–ª–∞ (–µ—Å–ª–∏ –Ω–µ —É–∫–∞–∑–∞–Ω–æ, –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏)
            single_file: –ï—Å–ª–∏ True, –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –∏–º—è —Ñ–∞–π–ª–∞ –¥–ª—è –æ–¥–Ω–æ–≥–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
            
        Returns:
            –ü—É—Ç—å –∫ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–æ–º—É —Ñ–∞–π–ª—É
        """
        if filename is None:
            if single_file and len(results) == 1:
                # –î–ª—è –æ–¥–Ω–æ–≥–æ —Ñ–∞–π–ª–∞ –∏—Å–ø–æ–ª—å–∑—É–µ–º –∏–º—è —Ñ–∞–π–ª–∞
                file_name = results[0].get('file_name', 'unknown')
                safe_name = Path(file_name).stem.replace(' ', '_').replace('(', '').replace(')', '')
                filename = f"result_{safe_name}.txt"
            else:
                # –î–ª—è –ø–∞–∫–µ—Ç–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∏—Å–ø–æ–ª—å–∑—É–µ–º –≤—Ä–µ–º–µ–Ω–Ω—É—é –º–µ—Ç–∫—É
                timestamp = datetime.now().strftime("%Y%m%d_%H%M%S")
                filename = f"result_{timestamp}.txt"
        
        filepath = Path(filename)
        
        with open(filepath, 'w', encoding='utf-8') as f:
            f.write("="*60 + "\n")
            f.write("–†–ï–ó–£–õ–¨–¢–ê–¢–´ –ê–ù–ê–õ–ò–ó–ê –ê–£–î–ò–û–§–ê–ô–õ–û–í\n")
            f.write("="*60 + "\n")
            f.write(f"–í—Ä–µ–º—è –∞–Ω–∞–ª–∏–∑–∞: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}\n")
            f.write(f"–í—Å–µ–≥–æ —Ñ–∞–π–ª–æ–≤: {len(results)}\n\n")
            
            for i, result in enumerate(results, 1):
                f.write("="*40 + "\n")
                f.write(f"–§–ê–ô–õ {i}: {result['file_name']}\n")
                f.write("="*40 + "\n")
                f.write(f"üìÅ –§–∞–π–ª: {result['file_name']}\n")
                f.write(f"üìä –†–∞–∑–º–µ—Ä: {result['file_size_mb']:.2f} –ú–ë\n")
                f.write(f"üè∑Ô∏è –¢–∏–ø –∞—É–¥–∏–æ: {result['audio_type']}\n")
                f.write(f"üìù –†–∞—Å–ø–æ–∑–Ω–∞–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç:\n")
                f.write(f"   {result['transcript']}\n")
                f.write(f"‚è∞ –í—Ä–µ–º—è –∞–Ω–∞–ª–∏–∑–∞: {result['analysis_time'].isoformat()}\n\n")
        
        return str(filepath.absolute())


def create_argument_parser() -> argparse.ArgumentParser:
    """
    –°–æ–∑–¥–∞–µ—Ç –ø–∞—Ä—Å–µ—Ä –∞—Ä–≥—É–º–µ–Ω—Ç–æ–≤ –∫–æ–º–∞–Ω–¥–Ω–æ–π —Å—Ç—Ä–æ–∫–∏.
    
    Returns:
        –ù–∞—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π –ø–∞—Ä—Å–µ—Ä –∞—Ä–≥—É–º–µ–Ω—Ç–æ–≤
    """
    parser = argparse.ArgumentParser(
        description="–ê–Ω–∞–ª–∏–∑–∞—Ç–æ—Ä –∞—É–¥–∏–æ—Ñ–∞–π–ª–æ–≤ —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º OpenAI API",
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
               –ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è:
         python main.py examples                    # –ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–π –≤—ã–±–æ—Ä —Ñ–∞–π–ª–∞
         python main.py --all-files examples       # –ü–∞–∫–µ—Ç–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –≤—Å–µ—Ö —Ñ–∞–π–ª–æ–≤
         python main.py --file examples/song.mp3   # –ê–Ω–∞–ª–∏–∑ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ —Ñ–∞–π–ª–∞
         python main.py --all-files examples --debug --save  # –° –æ—Ç–ª–∞–¥–∫–æ–π –∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º
         python main.py --file examples/song.mp3 --post-process --no-logging  # –° –ø–æ—Å—Ç-–æ–±—Ä–∞–±–æ—Ç–∫–æ–π –±–µ–∑ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
         python main.py --file examples/song.mp3 --enable-post-process  # –° –≤–∫–ª—é—á–µ–Ω–Ω–æ–π –ø–æ—Å—Ç-–æ–±—Ä–∞–±–æ—Ç–∫–æ–π –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
         python main.py --file examples/song.mp3 --fast-mode --no-logging  # –ë—ã—Å—Ç—Ä—ã–π —Ä–µ–∂–∏–º –±–µ–∑ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
         # –ü–∞—Ä–∞–º–µ—Ç—Ä—ã Demucs –∑–∞–¥–∞—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –≤ –±–ª–æ–∫–µ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –≤ –Ω–∞—á–∞–ª–µ —Ñ–∞–π–ª–∞
        """
    )
    
    parser.add_argument(
        'folder',
        nargs='?',
        default=DEFAULT_FOLDER,
        help=f'–ü—É—Ç—å –∫ –ø–∞–ø–∫–µ —Å –∞—É–¥–∏–æ—Ñ–∞–π–ª–∞–º–∏ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: {DEFAULT_FOLDER})'
    )
    
    parser.add_argument(
        '--all-files',
        action='store_true',
        help='–ü–∞–∫–µ—Ç–Ω–æ–µ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ –¥–ª—è –≤—Å–µ—Ö –∞—É–¥–∏–æ—Ñ–∞–π–ª–æ–≤ –≤ –ø–∞–ø–∫–µ'
    )
    
    parser.add_argument(
        '--file',
        type=str,
        help='–ü—É—Ç—å –∫ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–º—É —Ñ–∞–π–ª—É –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä: examples/song.mp3)'
    )
    
    parser.add_argument(
        '--save',
        action='store_true',
        default=True,
        help='–°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ä–∞–±–æ—Ç—ã –≤ —Ñ–∞–π–ª result_{time}.txt (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –≤–∫–ª—é—á–µ–Ω–æ)'
    )
    
    parser.add_argument(
        '--no-save',
        action='store_true',
        help='–ù–µ —Å–æ—Ö—Ä–∞–Ω—è—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –≤ —Ñ–∞–π–ª'
    )
    
    parser.add_argument(
        '--debug',
        action='store_true',
        help='–ü–æ–¥—Ä–æ–±–Ω—ã–π –≤—ã–≤–æ–¥ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤, –∑–∞–ø—Ä–æ—Å–∞ –∏ –æ—Ç–≤–µ—Ç–∞'
    )
    
    parser.add_argument(
        '--primary-lang',
        type=str,
        default=DEFAULT_PRIMARY_LANGUAGE,
        help=f'–û—Å–Ω–æ–≤–Ω–æ–π —è–∑—ã–∫ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: {DEFAULT_PRIMARY_LANGUAGE})'
    )
    
    parser.add_argument(
        '--secondary-lang',
        type=str,
        default=DEFAULT_SECONDARY_LANGUAGE,
        help=f'–ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π —è–∑—ã–∫ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: {DEFAULT_SECONDARY_LANGUAGE})'
    )
    
    parser.add_argument(
        '--post-process',
        action='store_true',
        default=False,
        help='–í–∫–ª—é—á–∏—Ç—å –ø–æ—Å—Ç-–æ–±—Ä–∞–±–æ—Ç–∫—É —Å LLM –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ü–∏–∏ –æ—à–∏–±–æ–∫ —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏–∏ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –≤—ã–∫–ª—é—á–µ–Ω–æ)'
    )
    
    parser.add_argument(
        '--no-logging',
        action='store_true',
        default=False,
        help='–û—Ç–∫–ª—é—á–∏—Ç—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ —Ñ–∞–π–ª (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –≤–∫–ª—é—á–µ–Ω–æ)'
    )
    
    parser.add_argument(
        '--enable-post-process',
        action='store_true',
        default=False,
        help='–í–∫–ª—é—á–∏—Ç—å –ø–æ—Å—Ç-–æ–±—Ä–∞–±–æ—Ç–∫—É —Å LLM –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –≤—ã–∫–ª—é—á–µ–Ω–æ)'
    )
    
    parser.add_argument(
        '--fast-mode',
        action='store_true',
        default=False,
        help='–ë—ã—Å—Ç—Ä—ã–π —Ä–µ–∂–∏–º: –æ—Ç–∫–ª—é—á–∏—Ç—å —É–ª—É—á—à–µ–Ω–∏–µ –∞—É–¥–∏–æ –∏ —É–º–µ–Ω—å—à–∏—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–ø—ã—Ç–æ–∫ —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏–∏'
    )
    
    
    return parser


def print_results(results: List[Dict[str, Union[str, float, datetime]]]) -> None:
    """
    –í—ã–≤–æ–¥–∏—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –∞–Ω–∞–ª–∏–∑–∞ –≤ –∫–æ–Ω—Å–æ–ª—å.
    
    Args:
        results: –°–ø–∏—Å–æ–∫ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –∞–Ω–∞–ª–∏–∑–∞
    """
    print("\n" + "="*50)
    print("üìä –†–ï–ó–£–õ–¨–¢–ê–¢–´ –ê–ù–ê–õ–ò–ó–ê")
    print("="*50)
    
    for i, result in enumerate(results, 1):
        print(f"\n--- –§–ê–ô–õ {i}/{len(results)} ---")
        print(f"üìÅ –§–∞–π–ª: {result['file_name']}")
        print(f"üè∑Ô∏è –¢–∏–ø –∞—É–¥–∏–æ: {result['audio_type']}")
        print(f"üìù –†–∞—Å–ø–æ–∑–Ω–∞–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç:")
        if result['transcript']:
            print(f"   {result['transcript']}")
        else:
            print("   –†–µ—á—å –Ω–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∞")
    
    print("\n" + "="*50)


def main() -> None:
    """–û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è."""
    parser = create_argument_parser()
    args = parser.parse_args()
    
    # –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–æ–Ω—Ñ–ª–∏–∫—Ç—É—é—â–∏—Ö –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
    if args.no_save:
        args.save = False
    
    # –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –±—ã—Å—Ç—Ä–æ–≥–æ —Ä–µ–∂–∏–º–∞
    global ENABLE_AUDIO_ENHANCEMENT, MAX_TRANSCRIPTION_ATTEMPTS
    if args.fast_mode:
        ENABLE_AUDIO_ENHANCEMENT = False
        MAX_TRANSCRIPTION_ATTEMPTS = 2
        print("üöÄ –ë–´–°–¢–†–´–ô –†–ï–ñ–ò–ú –í–ö–õ–Æ–ß–ï–ù: —É–ª—É—á—à–µ–Ω–∏–µ –∞—É–¥–∏–æ –æ—Ç–∫–ª—é—á–µ–Ω–æ, –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–ø—ã—Ç–æ–∫ —É–º–µ–Ω—å—à–µ–Ω–æ")
    
    try:
        # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –∞–Ω–∞–ª–∏–∑–∞—Ç–æ—Ä —Å –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏ —è–∑—ã–∫–æ–≤
        analyzer = AudioAnalyzer(
            primary_language=args.primary_lang,
            secondary_language=args.secondary_lang,
            enable_post_process=args.post_process or args.enable_post_process,
            enable_logging=not args.no_logging
        )
        
        if args.debug:
            print("üêõ –û–¢–õ–ê–î–û–ß–ù–´–ô –†–ï–ñ–ò–ú –í–ö–õ–Æ–ß–ï–ù")
            print(f"üìÅ –ü–∞–ø–∫–∞: {args.folder}")
            print(f"üîÑ –ü–∞–∫–µ—Ç–Ω—ã–π —Ä–µ–∂–∏–º: {args.all_files}")
            print(f"üìÑ –ö–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π —Ñ–∞–π–ª: {args.file}")
            print(f"üíæ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ: {args.save}")
            print(f"üåç –û—Å–Ω–æ–≤–Ω–æ–π —è–∑—ã–∫: {args.primary_lang}")
            print(f"üåç –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π —è–∑—ã–∫: {args.secondary_lang}")
            print(f"üîß –ü–æ—Å—Ç-–æ–±—Ä–∞–±–æ—Ç–∫–∞ LLM: {args.post_process or args.enable_post_process}")
            print(f"üìù –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ: {'–≤—ã–∫–ª—é—á–µ–Ω–æ' if args.no_logging else '–≤–∫–ª—é—á–µ–Ω–æ'}")
            print("-" * 50)
        
        results = []
        
        # –†–µ–∂–∏–º 1: –ê–Ω–∞–ª–∏–∑ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ —Ñ–∞–π–ª–∞
        if args.file:
            file_path = Path(args.file)
            if not file_path.exists():
                print(f"‚ùå –§–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω: {args.file}")
                return
            
            result = analyzer.analyze_audio(file_path, args.debug)
            results.append(result)
            
            print("\n" + "="*50)
            print("üìä –†–ï–ó–£–õ–¨–¢–ê–¢–´ –ê–ù–ê–õ–ò–ó–ê")
            print("="*50)
            print(f"üìÅ –§–∞–π–ª: {result['file_name']}")
            print(f"üè∑Ô∏è –¢–∏–ø –∞—É–¥–∏–æ: {result['audio_type']}")
            print(f"üìù –†–∞—Å–ø–æ–∑–Ω–∞–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç:")
            if result['transcript']:
                print(f"   {result['transcript']}")
            else:
                print("   –†–µ—á—å –Ω–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∞")
            print("="*50)
        
        # –†–µ–∂–∏–º 2: –ü–∞–∫–µ—Ç–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –≤—Å–µ—Ö —Ñ–∞–π–ª–æ–≤
        elif args.all_files:
            results = analyzer.analyze_all_files(args.folder, args.debug)
            print_results(results)
        
        # –†–µ–∂–∏–º 3: –ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–π –≤—ã–±–æ—Ä —Ñ–∞–π–ª–∞
        else:
            print(f"üîç –ò—â—É –∞—É–¥–∏–æ—Ñ–∞–π–ª—ã –≤ –ø–∞–ø–∫–µ: {args.folder}")
            try:
                files = analyzer.list_audio_files(args.folder)
                print(f"‚úÖ –ù–∞–π–¥–µ–Ω–æ {len(files)} –∞—É–¥–∏–æ—Ñ–∞–π–ª–æ–≤")
                
                chosen_file = analyzer.choose_file(files)
                if chosen_file:
                    result = analyzer.analyze_audio(chosen_file, args.debug)
                    results.append(result)
                    
                    print("\n" + "="*50)
                    print("üìä –†–ï–ó–£–õ–¨–¢–ê–¢–´ –ê–ù–ê–õ–ò–ó–ê")
                    print("="*50)
                    print(f"üìÅ –§–∞–π–ª: {result['file_name']}")
                    print(f"üè∑Ô∏è –¢–∏–ø –∞—É–¥–∏–æ: {result['audio_type']}")
                    print(f"üìù –†–∞—Å–ø–æ–∑–Ω–∞–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç:")
                    if result['transcript']:
                        print(f"   {result['transcript']}")
                    else:
                        print("   –†–µ—á—å –Ω–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∞")
                    print("="*50)
                else:
                    print("üëã –û–ø–µ—Ä–∞—Ü–∏—è –æ—Ç–º–µ–Ω–µ–Ω–∞")
                    return
            except FileNotFoundError as e:
                print(f"‚ùå {e}")
                return
        
        # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
        if args.save and results:
            single_file_mode = len(results) == 1
            saved_file = analyzer.save_results(results, single_file=single_file_mode)
            print(f"\nüíæ –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤ —Ñ–∞–π–ª: {saved_file}")
        
    except KeyboardInterrupt:
        print("\nüëã –†–∞–±–æ—Ç–∞ –ø—Ä–µ—Ä–≤–∞–Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º")
    except Exception as e:
        print(f"‚ùå –û—à–∏–±–∫–∞: {e}")


if __name__ == "__main__":
    main()